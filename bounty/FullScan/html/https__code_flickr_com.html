<!DOCTYPE html>
<!--[if IE 6]>
<html id="ie6" lang="en">
<![endif]-->
<!--[if IE 7]>
<html id="ie7" lang="en">
<![endif]-->
<!--[if IE 8]>
<html id="ie8" lang="en">
<![endif]-->
<!--[if !(IE 6) & !(IE 7) & !(IE 8)]><!-->
<html lang="en">
<!--<![endif]-->
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width" />
<title>code.flickr.com</title>
<link rel="profile" href="http://gmpg.org/xfn/11" />
<link rel="stylesheet" type="text/css" media="all" href="https://s2.wp.com/wp-content/themes/vip/flickr-code/style.css" />
<link rel="pingback" href="https://code.flickr.net/xmlrpc.php">
<!--[if lt IE 9]>
<script src="https://s2.wp.com/wp-content/themes/pub/twentyeleven/js/html5.js" type="text/javascript"></script>
<![endif]-->
		<script src='https://r-login.wordpress.com/remote-login.php?action=js&amp;host=code.flickr.net&amp;id=39034126&amp;t=1565156363&amp;back=https%3A%2F%2Fcode.flickr.net%2F' type="text/javascript"></script>
		<script type="text/javascript">
		/* <![CDATA[ */
			if ( 'function' === typeof WPRemoteLogin ) {
				document.cookie = "wordpress_test_cookie=test; path=/";
				if ( document.cookie.match( /(;|^)\s*wordpress_test_cookie\=/ ) ) {
					WPRemoteLogin();
				}
			}
		/* ]]> */
		</script>
		<link rel='dns-prefetch' href='//s2.wp.com' />
<link rel='dns-prefetch' href='//s1.wp.com' />
<link rel='dns-prefetch' href='//s0.wp.com' />
<link rel='dns-prefetch' href='//flickrcode.wordpress.com' />
<link rel="alternate" type="application/rss+xml" title="code.flickr.com &raquo; Feed" href="https://code.flickr.net/feed/" />
<link rel="alternate" type="application/rss+xml" title="code.flickr.com &raquo; Comments Feed" href="https://code.flickr.net/comments/feed/" />
	<script type="text/javascript">
		/* <![CDATA[ */
		function addLoadEvent(func) {
			var oldonload = window.onload;
			if (typeof window.onload != 'function') {
				window.onload = func;
			} else {
				window.onload = function () {
					oldonload();
					func();
				}
			}
		}
		/* ]]> */
	</script>
			<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s0.wp.com\/wp-content\/mu-plugins\/wpcom-smileys\/twemoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s0.wp.com\/wp-content\/mu-plugins\/wpcom-smileys\/twemoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/s2.wp.com\/wp-includes\/js\/wp-emoji-release.min.js?m=1556893897h&ver=5.2.2"}};
			!function(a,b,c){function d(a,b){var c=String.fromCharCode;l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,a),0,0);var d=k.toDataURL();l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,b),0,0);var e=k.toDataURL();return d===e}function e(a){var b;if(!l||!l.fillText)return!1;switch(l.textBaseline="top",l.font="600 32px Arial",a){case"flag":return!(b=d([55356,56826,55356,56819],[55356,56826,8203,55356,56819]))&&(b=d([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]),!b);case"emoji":return b=d([55357,56424,55356,57342,8205,55358,56605,8205,55357,56424,55356,57340],[55357,56424,55356,57342,8203,55358,56605,8203,55357,56424,55356,57340]),!b}return!1}function f(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var g,h,i,j,k=b.createElement("canvas"),l=k.getContext&&k.getContext("2d");for(j=Array("flag","emoji"),c.supports={everything:!0,everythingExceptFlag:!0},i=0;i<j.length;i++)c.supports[j[i]]=e(j[i]),c.supports.everything=c.supports.everything&&c.supports[j[i]],"flag"!==j[i]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[j[i]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(h=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",h,!1),a.addEventListener("load",h,!1)):(a.attachEvent("onload",h),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),g=c.source||{},g.concatemoji?f(g.concatemoji):g.wpemoji&&g.twemoji&&(f(g.twemoji),f(g.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel='stylesheet' id='all-css-0-1' href='https://s0.wp.com/_static/??-eJyNkdtuwjAMhl9owWODcTXtWZLUpKY5KXGp+vZzC2xCjGg3kQ//l/x2YMrKpsgYGcKosh8dxQqeBqxwQs7aDmrNNrbWFxA5RevHTtpSgI4qg/FpVZmiywyVZ4+bQPHfBPcY7ok/LNlUUOoha14UATvS6AWM3MJC/rhRS9jLPLWln7KolTG5YK1KzkBjUKvDR+5Shjwa4EkKsxg6Y7yu4In6TBmOnuxQpNNhW/xw9bq5qxOCmJiEqD9BazSHSQmtmVK8S9TRayottKC86yR06x/+ps989ztwPhntF8FX+Nzu94e33fbw/nr6BhAJ6tI=?cssminify=yes' type='text/css' media='all' />
<script type='text/javascript' src='https://s2.wp.com/_static/??-eJyFztEKwjAMBdAfsisyOnwRv6XWOFKXtDbphn69HeiDMBQC9+EeuLFLNshhqhcQG9vdK5THO7ooO/sLGMKxeIWOkD84JFZgXW1OogQifoSNltIZJzBVoDTA2mauacN9v4Q8Iyx/WQTNPtxMAcHnun6i4965Q++GwfXxBTkPW9k='></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://flickrcode.wordpress.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://s1.wp.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress.com" />
<link rel='shortlink' href='https://wp.me/2DMyG' />
<link rel="shortcut icon" type="image/x-icon" href="https://secure.gravatar.com/blavatar/8b1d73fba9c0d02a3e78929d8cecfd82?s=32" sizes="16x16" />
<link rel="icon" type="image/x-icon" href="https://secure.gravatar.com/blavatar/8b1d73fba9c0d02a3e78929d8cecfd82?s=32" sizes="16x16" />
<link rel="apple-touch-icon-precomposed" href="https://secure.gravatar.com/blavatar/8b1d73fba9c0d02a3e78929d8cecfd82?s=114" />
<link rel='openid.server' href='https://flickrcode.wordpress.com/?openidserver=1' />
<link rel='openid.delegate' href='https://flickrcode.wordpress.com/' />
<link rel="search" type="application/opensearchdescription+xml" href="https://code.flickr.net/osd.xml" title="code.flickr.com" />
<link rel="search" type="application/opensearchdescription+xml" href="https://s1.wp.com/opensearch.xml" title="WordPress.com" />
<meta name="application-name" content="code.flickr.com" /><meta name="msapplication-window" content="width=device-width;height=device-height" /><meta name="msapplication-task" content="name=Subscribe;action-uri=https://code.flickr.net/feed/;icon-uri=https://secure.gravatar.com/blavatar/8b1d73fba9c0d02a3e78929d8cecfd82?s=16" />	<style type="text/css" id="twentyeleven-header-css">
			#site-title,
		#site-description {
			position: absolute;
			clip: rect(1px 1px 1px 1px); /* IE6, IE7 */
			clip: rect(1px, 1px, 1px, 1px);
		}
		</style>
			<link rel="stylesheet" id="custom-css-css" type="text/css" href="https://s2.wp.com/?custom-css=1&#038;csblog=2DMyG&#038;cscache=6&#038;csrev=106" />
		</head>

<body class="home blog custom-background wp-embed-responsive mp6 customizer-styles-applied two-column right-sidebar highlander-enabled highlander-light">
<div id="page" class="hfeed">
	<header id="branding" role="banner">
			<hgroup>
				<h1 id="site-title"><span><a href="https://code.flickr.net/" rel="home">code.flickr.com</a></span></h1>
				<h2 id="site-description"></h2>
			</hgroup>

						<a href="https://code.flickr.net/">
									<img src="https://flickrcode.files.wordpress.com/2012/09/code-flickr-com-drawn-header-grey-large.png" width="1000" height="157" alt="" />
							</a>
			
							<div class="only-search with-image">
					<form method="get" id="searchform" action="https://code.flickr.net/">
		<label for="s" class="assistive-text">Search</label>
		<input type="text" class="field" name="s" id="s" placeholder="Search" />
		<input type="submit" class="submit" name="submit" id="searchsubmit" value="Search" />
	</form>
				</div>
			
			<nav id="access" role="navigation">
				<h3 class="assistive-text">Main menu</h3>
								<div class="skip-link"><a class="assistive-text" href="#content">Skip to primary content</a></div>
									<div class="skip-link"><a class="assistive-text" href="#secondary">Skip to secondary content</a></div>
												<div class="menu-menu-container"><ul id="menu-menu" class="menu"><li id="menu-item-2084" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-2084"><a href="http://www.flickr.com/">Flickr</a></li>
<li id="menu-item-2085" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-2085"><a href="http://blog.flickr.net/">Flickr Blog</a></li>
<li id="menu-item-2250" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-2250"><a href="http://twitter.com/flickr">@flickr</a></li>
<li id="menu-item-2086" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-2086"><a href="http://twitter.com/flickrapi">@flickrapi</a></li>
<li id="menu-item-2087" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-2087"><a href="http://developer.flickr.com/">Developer Guidelines</a></li>
<li id="menu-item-2088" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-2088"><a href="http://www.flickr.com/services/api/">API</a></li>
<li id="menu-item-2089" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-2089"><a href="http://www.flickr.com/jobs/">Jobs</a></li>
</ul></div>			</nav><!-- #access -->
	</header><!-- #branding -->


	<div id="main">

		<div id="primary">
			<div id="content" role="main">

			
						<nav id="nav-above">
			<h3 class="assistive-text">Post navigation</h3>
			<div class="nav-previous"><a href="https://code.flickr.net/page/2/" ><span class="meta-nav">&larr;</span> Older posts</a></div>
			<div class="nav-next"></div>
		</nav><!-- #nav-above -->
	
								
					
	<article id="post-3590" class="post-3590 post type-post status-publish format-standard hentry category-uncategorized">
		<header class="entry-header">
						<h1 class="entry-title"><a href="https://code.flickr.net/2018/04/20/together/" rel="bookmark">Together</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="https://code.flickr.net/2018/04/20/together/" title="3:15 pm" rel="bookmark"><time class="entry-date" datetime="2018-04-20T15:15:17-07:00">April 20, 2018</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="https://code.flickr.net/author/almonroth/" title="View all posts by Matthew Roth" rel="author">Matthew Roth</a></span></span>			</div><!-- .entry-meta -->
			
					</header><!-- .entry-header -->

				<div class="entry-content">
			<p>Flickr is excited to be <a href="https://www.smugmug.com/together">joining SmugMug</a>!</p>
<p>We’re looking forward to some interesting and challenging engineering projects in the next year, and would love to have more great people join the team!</p>
<p>We want to talk to people who are interested in working on an inclusive, diverse team, building large-scale systems that are backing a much-loved product.</p>
<p>You can learn more about open positions at: <a href="http://jobs.smugmug.com/">http://jobs.smugmug.com/</a></p>
<p>Read our <a href="https://blog.flickr.net/en/2018/04/20/together-smugmug-flickr/">announcement blog post</a> and <a href="https://blog.flickr.net/en/2018/04/20/together-smugmug-flickr-faq/">our extended Q&amp;A</a> for more details.</p>
<p>~The Flickr Team</p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="https://code.flickr.net/category/uncategorized/" rel="category tag">Uncategorized</a>			</span>
															
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-3590 -->

				
					
	<article id="post-3571" class="post-3571 post type-post status-publish format-standard hentry category-uncategorized tag-machine-learning tag-machine-tags tag-neural-network tag-similarity-search tag-visual-similarity">
		<header class="entry-header">
						<h1 class="entry-title"><a href="https://code.flickr.net/2017/03/07/introducing-similarity-search-at-flickr/" rel="bookmark">Introducing Similarity Search at&nbsp;Flickr</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="https://code.flickr.net/2017/03/07/introducing-similarity-search-at-flickr/" title="6:04 pm" rel="bookmark"><time class="entry-date" datetime="2017-03-07T18:04:36-07:00">March 7, 2017</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="https://code.flickr.net/author/claytonhoo/" title="View all posts by Clayton Mellina" rel="author">Clayton Mellina</a></span></span>			</div><!-- .entry-meta -->
			
					</header><!-- .entry-header -->

				<div class="entry-content">
			<p><span style="font-weight:400;">At Flickr, we understand that the value in our image corpus is only unlocked when our members can find photos and photographers that inspire them, so we strive to enable the discovery and appreciation of new photos.</span></p>
<p><span style="font-weight:400;">To further that effort, today we are introducing </span><b>similarity search</b><span style="font-weight:400;"> on Flickr. If you hover over a photo on a search result page, you will reveal a “&#8230;” button that exposes a menu that gives you the option to search for photos similar to the photo you are currently viewing.</span></p>
<p><span style="font-weight:400;">In many ways, photo search is very different from traditional web or text search. First, the goal of web search is usually to satisfy a particular information need, while with photo search the goal is often one of </span><i><span style="font-weight:400;">discovery</span></i><span style="font-weight:400;">; as such, it should be delightful as well as functional. We have taken this to heart throughout Flickr. For instance, our color search feature, which allows filtering by color scheme, and our style filters, which allow filtering by styles such as “minimalist” or “patterns,” encourage exploration. Second, in traditional web search, the goal is usually to match documents to a set of keywords in the query. That is, the query is in the same modality—text—as the documents being searched. Photo search usually matches </span><i><span style="font-weight:400;">across</span></i><span style="font-weight:400;"> modalities: text to image. Text querying is a necessary feature of a photo search engine, but, as the saying goes, a picture is worth a thousand words. And beyond saving people the effort of so much typing, many visual concepts genuinely defy accurate description. Now, we’re giving our community a way to easily explore those visual concepts with the “&#8230;” button, a feature we call the </span><b>similarity pivot</b><span style="font-weight:400;">.</span></p>
<p><img data-attachment-id="3572" data-permalink="https://code.flickr.net/2017/03/07/introducing-similarity-search-at-flickr/demo/" data-orig-file="https://flickrcode.files.wordpress.com/2017/03/demo.gif" data-orig-size="1277,658" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="similarity demo" data-image-description="" data-medium-file="https://flickrcode.files.wordpress.com/2017/03/demo.gif?w=800" data-large-file="https://flickrcode.files.wordpress.com/2017/03/demo.gif?w=800" class="alignnone size-medium wp-image-3572" src="https://flickrcode.files.wordpress.com/2017/03/demo.gif?w=800&#038;h=412" alt="" width="800" height="412" /></p>
<p><span style="font-weight:400;">The similarity pivot is a significant addition to the Flickr experience because it offers our community an entirely new way to explore and discover the billions of incredible photos and millions of incredible photographers on Flickr. It allows people to look for </span><a href="https://www.flickr.com/search/?similarity_id=29327172003"><span style="font-weight:400;">images of a particular style</span></a><span style="font-weight:400;">, it gives people a view into </span><a href="https://www.flickr.com/search/?similarity_id=5742058855"><span style="font-weight:400;">universal behaviors</span></a><span style="font-weight:400;">, and even when it “messes up,” it can force people to look at the </span><a href="https://www.flickr.com/search/?similarity_id=14198128453"><span style="font-weight:400;">unexpected</span></a> <a href="https://www.flickr.com/search/?similarity_id=28863966765"><span style="font-weight:400;">commonalities</span></a><span style="font-weight:400;"> and </span><a href="https://www.flickr.com/search/?similarity_id=8002923505"><span style="font-weight:400;">oddities</span></a><span style="font-weight:400;"> of our visual world with a </span><a href="https://www.flickr.com/search/?similarity_id=13759436465"><span style="font-weight:400;">fresh</span></a> <a href="https://www.flickr.com/search/?similarity_id=15346205045"><span style="font-weight:400;">perspective</span></a><span style="font-weight:400;">.</span></p>
<h2><span style="font-weight:400;">What is “similarity”?</span></h2>
<p><span style="font-weight:400;">To understand how an experience like this is powered, we first need to understand what we mean by “similarity.” There are many ways photos can be similar to one another. Consider some examples.</span></p>
<p><img data-attachment-id="3573" data-permalink="https://code.flickr.net/2017/03/07/introducing-similarity-search-at-flickr/color_sim/" data-orig-file="https://flickrcode.files.wordpress.com/2017/03/color_sim.png" data-orig-size="1033,443" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="color_sim" data-image-description="" data-medium-file="https://flickrcode.files.wordpress.com/2017/03/color_sim.png?w=800" data-large-file="https://flickrcode.files.wordpress.com/2017/03/color_sim.png?w=800" class="alignnone size-medium wp-image-3573" src="https://flickrcode.files.wordpress.com/2017/03/color_sim.png?w=800&#038;h=343" alt="" width="800" height="343" srcset="https://flickrcode.files.wordpress.com/2017/03/color_sim.png?w=800&amp;h=343 800w, https://flickrcode.files.wordpress.com/2017/03/color_sim.png?w=150&amp;h=64 150w, https://flickrcode.files.wordpress.com/2017/03/color_sim.png?w=768&amp;h=329 768w, https://flickrcode.files.wordpress.com/2017/03/color_sim.png?w=1024&amp;h=439 1024w, https://flickrcode.files.wordpress.com/2017/03/color_sim.png 1033w" sizes="(max-width: 800px) 100vw, 800px" /></p>
<p><img data-attachment-id="3576" data-permalink="https://code.flickr.net/2017/03/07/introducing-similarity-search-at-flickr/texture_sim/" data-orig-file="https://flickrcode.files.wordpress.com/2017/03/texture_sim.png" data-orig-size="1030,442" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="texture_sim" data-image-description="" data-medium-file="https://flickrcode.files.wordpress.com/2017/03/texture_sim.png?w=800" data-large-file="https://flickrcode.files.wordpress.com/2017/03/texture_sim.png?w=800" class="alignnone size-medium wp-image-3576" src="https://flickrcode.files.wordpress.com/2017/03/texture_sim.png?w=800&#038;h=343" alt="" width="800" height="343" srcset="https://flickrcode.files.wordpress.com/2017/03/texture_sim.png?w=800&amp;h=343 800w, https://flickrcode.files.wordpress.com/2017/03/texture_sim.png?w=150&amp;h=64 150w, https://flickrcode.files.wordpress.com/2017/03/texture_sim.png?w=768&amp;h=330 768w, https://flickrcode.files.wordpress.com/2017/03/texture_sim.png?w=1024&amp;h=439 1024w, https://flickrcode.files.wordpress.com/2017/03/texture_sim.png 1030w" sizes="(max-width: 800px) 100vw, 800px" /></p>
<p><img data-attachment-id="3575" data-permalink="https://code.flickr.net/2017/03/07/introducing-similarity-search-at-flickr/semantic_sim/" data-orig-file="https://flickrcode.files.wordpress.com/2017/03/semantic_sim.png" data-orig-size="1029,443" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="semantic_sim" data-image-description="" data-medium-file="https://flickrcode.files.wordpress.com/2017/03/semantic_sim.png?w=800" data-large-file="https://flickrcode.files.wordpress.com/2017/03/semantic_sim.png?w=800" class="alignnone size-medium wp-image-3575" src="https://flickrcode.files.wordpress.com/2017/03/semantic_sim.png?w=800&#038;h=344" alt="" width="800" height="344" srcset="https://flickrcode.files.wordpress.com/2017/03/semantic_sim.png?w=800&amp;h=344 800w, https://flickrcode.files.wordpress.com/2017/03/semantic_sim.png?w=150&amp;h=65 150w, https://flickrcode.files.wordpress.com/2017/03/semantic_sim.png?w=768&amp;h=331 768w, https://flickrcode.files.wordpress.com/2017/03/semantic_sim.png?w=1024&amp;h=441 1024w, https://flickrcode.files.wordpress.com/2017/03/semantic_sim.png 1029w" sizes="(max-width: 800px) 100vw, 800px" /></p>
<p><span style="font-weight:400;">It is apparent that all of these groups of photos illustrate some notion of “similarity,” but each is different. Roughly, they are: similarity of color, similarity of texture, and similarity of semantic category. And there are many others that you might imagine as well.</span></p>
<p>What notion of similarity is best suited for a site like Flickr? Ideally, we’d like to be able to capture multiple types of similarity, but we decided early on that semantic similarity—similarity based on the semantic content of the photos—was vital to facilitate discovery on Flickr. This requires a deep understanding of image content for which we employ deep neural networks.</p>
<p>We have been using deep neural networks at Flickr for a while for various tasks such as object recognition, NSFW prediction, and even prediction of aesthetic quality. For these tasks, we train a neural network to map the raw pixels of a photo into a set of relevant tags, as illustrated below.</p>
<p><img data-attachment-id="3578" data-permalink="https://code.flickr.net/2017/03/07/introducing-similarity-search-at-flickr/nn_tag/" data-orig-file="https://flickrcode.files.wordpress.com/2017/03/nn_tag.png" data-orig-size="1408,404" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="nn_tag" data-image-description="" data-medium-file="https://flickrcode.files.wordpress.com/2017/03/nn_tag.png?w=800" data-large-file="https://flickrcode.files.wordpress.com/2017/03/nn_tag.png?w=800" class="alignnone size-medium wp-image-3578" src="https://flickrcode.files.wordpress.com/2017/03/nn_tag.png?w=800&#038;h=230" alt="" width="800" height="230" srcset="https://flickrcode.files.wordpress.com/2017/03/nn_tag.png?w=800&amp;h=230 800w, https://flickrcode.files.wordpress.com/2017/03/nn_tag.png?w=150&amp;h=43 150w, https://flickrcode.files.wordpress.com/2017/03/nn_tag.png?w=768&amp;h=220 768w, https://flickrcode.files.wordpress.com/2017/03/nn_tag.png?w=1024&amp;h=294 1024w, https://flickrcode.files.wordpress.com/2017/03/nn_tag.png 1408w" sizes="(max-width: 800px) 100vw, 800px" /></p>
<p><span style="font-weight:400;">Internally, the neural network accomplishes this mapping incrementally by applying a series of transformations to the image, which can be thought of as a vector of numbers corresponding to the pixel intensities. Each transformation in the series produces another vector, which is in turn the input to the next transformation, until finally we have a vector that we specifically constrain to be a list of probabilities for each class we are trying to recognize in the image. To be able to go from raw pixels to a semantic label like “hot air balloon,” the network discards lots of information about the image, including information about  appearance, such as the color of the balloon, its relative position in the sky, etc. Instead, we can extract an internal vector in the network before the final output.</span></p>
<p><img data-attachment-id="3579" data-permalink="https://code.flickr.net/2017/03/07/introducing-similarity-search-at-flickr/nn_feature/" data-orig-file="https://flickrcode.files.wordpress.com/2017/03/nn_feature.png" data-orig-size="1244,712" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="nn_feature" data-image-description="" data-medium-file="https://flickrcode.files.wordpress.com/2017/03/nn_feature.png?w=800" data-large-file="https://flickrcode.files.wordpress.com/2017/03/nn_feature.png?w=800" class="alignnone size-medium wp-image-3579" src="https://flickrcode.files.wordpress.com/2017/03/nn_feature.png?w=800&#038;h=458" alt="" width="800" height="458" srcset="https://flickrcode.files.wordpress.com/2017/03/nn_feature.png?w=800&amp;h=458 800w, https://flickrcode.files.wordpress.com/2017/03/nn_feature.png?w=150&amp;h=86 150w, https://flickrcode.files.wordpress.com/2017/03/nn_feature.png?w=768&amp;h=440 768w, https://flickrcode.files.wordpress.com/2017/03/nn_feature.png?w=1024&amp;h=586 1024w, https://flickrcode.files.wordpress.com/2017/03/nn_feature.png 1244w" sizes="(max-width: 800px) 100vw, 800px" /></p>
<p><span style="font-weight:400;">For common neural network architectures, this vector—which we call a “feature vector”—has many hundreds or thousands of dimensions. We can’t necessarily say with certainty that any one of these dimensions means something in particular as we could at the final network output, whose dimensions correspond to tag probabilities. But these vectors have an important property: when you compute the </span><a href="https://en.wikipedia.org/wiki/Euclidean_distance"><span style="font-weight:400;">Euclidean distance</span></a><span style="font-weight:400;"> between these vectors, images containing similar content will tend to have feature vectors closer together than images containing dissimilar content. You can think of this as a way that the network has learned to organize information present in the image so that it can output the required class prediction. This is exactly what we are looking for: Euclidian distance in this high-dimensional feature space is a measure of semantic similarity. The graphic below illustrates this idea: points in the neighborhood around the query image are semantically similar to the query image, whereas points in neighborhoods further away are not.</span></p>
<p><img data-attachment-id="3580" data-permalink="https://code.flickr.net/2017/03/07/introducing-similarity-search-at-flickr/retrieval/" data-orig-file="https://flickrcode.files.wordpress.com/2017/03/retrieval.png" data-orig-size="1686,772" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="retrieval" data-image-description="" data-medium-file="https://flickrcode.files.wordpress.com/2017/03/retrieval.png?w=800" data-large-file="https://flickrcode.files.wordpress.com/2017/03/retrieval.png?w=800" class="alignnone size-medium wp-image-3580" src="https://flickrcode.files.wordpress.com/2017/03/retrieval.png?w=800&#038;h=366" alt="" width="800" height="366" srcset="https://flickrcode.files.wordpress.com/2017/03/retrieval.png?w=800&amp;h=366 800w, https://flickrcode.files.wordpress.com/2017/03/retrieval.png?w=1600&amp;h=732 1600w, https://flickrcode.files.wordpress.com/2017/03/retrieval.png?w=150&amp;h=69 150w, https://flickrcode.files.wordpress.com/2017/03/retrieval.png?w=768&amp;h=352 768w, https://flickrcode.files.wordpress.com/2017/03/retrieval.png?w=1024&amp;h=469 1024w" sizes="(max-width: 800px) 100vw, 800px" /></p>
<p><span style="font-weight:400;">This measure of similarity is not perfect and cannot capture all possible notions of similarity—it will be constrained by the particular task the network was trained to perform, i.e., scene recognition. However, it is effective for our purposes, and, importantly, it contains information beyond merely the semantic content of the image, such as appearance, composition, and texture. Most importantly, it gives us a simple algorithm for finding visually similar photos: compute the distance in the feature space of a query image to each index image and return the images with lowest distance. Of course, there is much more work to do to make this idea work for billions of images.</span></p>
<h2><span style="font-weight:400;">Large-scale approximate nearest neighbor search</span></h2>
<p><span style="font-weight:400;">With an index as large as Flickr’s, computing distances exhaustively for each query is intractable. Additionally, storing a high-dimensional floating point feature vector for each of billions of images takes a large amount of disk space and poses even more difficulty if these features need to be in memory for fast ranking. To solve these two issues, we adopt a state-of-the-art approximate nearest neighbor algorithm called </span><a href="http://image.ntua.gr/iva/files/lopq.pdf"><span style="font-weight:400;">Locally Optimized Product Quantization</span></a><span style="font-weight:400;"> (LOPQ).</span></p>
<p><span style="font-weight:400;">To understand LOPQ, it is useful to first look at a simple strategy. Rather than ranking all vectors in the index, we can first filter a set of good candidates and only do expensive distance computations on them. For example, we can use an algorithm like </span><a href="https://en.wikipedia.org/wiki/K-means_clustering"><i><span style="font-weight:400;">k</span></i><span style="font-weight:400;">-means</span></a><span style="font-weight:400;"> to cluster our index vectors, find the cluster to which each vector is assigned, and index the corresponding cluster id for each vector. At query time, we find the cluster that the query vector is assigned to and fetch the items that belong to the same cluster from the index. We can even expand this set if we like by fetching items from the next nearest cluster.</span></p>
<p><span style="font-weight:400;">This idea will take us far, but not far enough for a billions-scale index. For example, with 1 billion photos, we need 1 million clusters so that each cluster contains an average of 1000 photos. At query time, we will have to compute the distance from the query to each of these 1 million cluster centroids in order to find the nearest clusters. This is quite a lot. We can do better, however, if we instead split our vectors in half by dimension and cluster each half separately. In this scheme, each vector will be assigned to a pair of cluster ids, one for each half of the vector. If we choose k = 1000 to cluster both halves, we have k<sup>2</sup>= 1000 * 1000 = 1e6 possible pairs. In other words, by clustering each half separately and assigning each item a pair of cluster ids, we can get the same granularity of partitioning (1 million clusters total) with only 2 * 1000 distance computations with half the number of dimensions for a total computational savings of 1000x. Conversely, for the same computational cost, we gain a factor of k more partitions of the data space, providing a much finer-grained index.</span></p>
<p><span style="font-weight:400;">This idea of splitting vectors into subvectors and clustering each split separately is called </span><a href="https://lear.inrialpes.fr/pubs/2011/JDS11/jegou_searching_with_quantization.pdf"><i><span style="font-weight:400;">product quantization</span></i></a><span style="font-weight:400;">. When we use this idea to index a dataset it is called the </span><a href="http://cache-ash04.cdn.yandex.net/download.yandex.ru/company/cvpr2012.pdf"><i><span style="font-weight:400;">inverted multi-index</span></i></a><span style="font-weight:400;">, and it forms the basis for fast candidate retrieval in our similarity index. Typically the distribution of points over the clusters in a multi-index will be unbalanced as compared to a standard k-means index, but this unbalance is a fair trade for the much higher resolution partitioning that it buys us. In fact, a multi-index will only be balanced across clusters if the two halves of the vectors are perfectly statistically independent. This is not the case in most real world data, but some heuristic preprocessing—like </span><a href="https://en.wikipedia.org/wiki/Principal_component_analysis"><span style="font-weight:400;">PCA-ing</span></a><span style="font-weight:400;"> and permuting the dimensions so that the cumulative per-dimension variance is approximately balanced between the halves—helps in many cases. And just like the simple k-means index, there is a fast algorithm for finding a ranked list of clusters to a query if we need to expand the candidate set.</span></p>
<p><span style="font-weight:400;">After we have a set of candidates, we must rank them. We could store the full vector in the index and use it to compute the distance for each candidate item, but this would incur a large memory overhead (for example, 256 dimensional vectors of 4 byte floats would require 1Tb for 1 billion photos) as well as a computational overhead. LOPQ solves these issues by performing another product quantization, this time on the </span><i><span style="font-weight:400;">residuals</span></i><span style="font-weight:400;"> of the data. The residual of a point is the difference vector between the point and its closest cluster centroid. Given a residual vector and the cluster indexes along with the corresponding centroids, we have enough information to reproduce the original vector exactly. Instead of storing the residuals, LOPQ product quantizes the residuals, usually with a higher number of splits, and stores only the cluster indexes in the index. For example, if we split the vector into 8 splits and each split is clustered with 256 centroids, we can store the compressed vector with only 8 bytes regardless of the number of dimensions to start (though certainly a higher number of dimensions will result in higher approximation error). With this </span><a href="https://en.wikipedia.org/wiki/Lossy_compression"><span style="font-weight:400;">lossy representation</span></a><span style="font-weight:400;"> we can produce a reconstruction of a vector from the 8 byte codes: we simply take each quantization code, look up the corresponding centroid, and concatenate these 8 centroids together to produce a reconstruction. Likewise, we can approximate the distance from the query to an index vector by computing the distance between the query and the reconstruction. We can do this computation quickly for many candidate points by computing the squared difference of each split of the query to all of the centroids for that split. After computing this table, we can compute the squared difference for an index point by looking up the precomputed squared difference for each of the 8 indexes and summing them together to get the total squared difference. This caching trick allows us to quickly rank many candidates without resorting to distance computations in the original vector space.</span></p>
<p>LOPQ adds one final detail: for each cluster in the multi-index, LOPQ fits a local rotation to the residuals of the points that fall in that cluster. This rotation is simply a PCA that aligns the major directions of variation in the data to the axes followed by a permutation to heuristically balance the variance across the splits of the product quantization. Note that this is the exact preprocessing step that is usually performed at the top-level multi-index. It tends to make the approximate distance computations more accurate by mitigating errors introduced by assuming that each split of the vector in the production quantization is statistically independent from other splits. Additionally, since a rotation is fit for each cluster, they serve to fit the local data distribution better.</p>
<p>Below is a diagram from the LOPQ paper that illustrates the core ideas of LOPQ. K-means (a) is very effective at allocating cluster centroids, illustrated as red points, that target the distribution of the data, but it has other drawbacks at scale as discussed earlier. In the 2d example shown, we can imagine product quantizing the space with 2 splits, each with 1 dimension. Product Quantization (b) clusters each dimension independently and cluster centroids are specified by pairs of cluster indexes, one for each split. This is effectively a grid over the space. Since the splits are treated as if they were statistically independent, we will, unfortunately, get many clusters that are “wasted” by not targeting the data distribution. We can improve on this situation by rotating the data such that the main dimensions of variation are axis-aligned. This version, called Optimized Product Quantization (c), does a better job of making sure each centroid is useful. LOPQ (d) extends this idea by first coarsely clustering the data and then doing a separate instance of OPQ for each cluster, allowing highly targeted centroids while still reaping the benefits of product quantization in terms of scalability.</p>
<p><img data-attachment-id="3581" data-permalink="https://code.flickr.net/2017/03/07/introducing-similarity-search-at-flickr/lopq/" data-orig-file="https://flickrcode.files.wordpress.com/2017/03/lopq.png" data-orig-size="1022,880" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="lopq" data-image-description="" data-medium-file="https://flickrcode.files.wordpress.com/2017/03/lopq.png?w=800" data-large-file="https://flickrcode.files.wordpress.com/2017/03/lopq.png?w=800" class="alignnone size-medium wp-image-3581" src="https://flickrcode.files.wordpress.com/2017/03/lopq.png?w=800&#038;h=689" alt="" width="800" height="689" srcset="https://flickrcode.files.wordpress.com/2017/03/lopq.png?w=800&amp;h=689 800w, https://flickrcode.files.wordpress.com/2017/03/lopq.png?w=150&amp;h=129 150w, https://flickrcode.files.wordpress.com/2017/03/lopq.png?w=768&amp;h=661 768w, https://flickrcode.files.wordpress.com/2017/03/lopq.png 1022w" sizes="(max-width: 800px) 100vw, 800px" /></p>
<p><span style="font-weight:400;">LOPQ is state-of-the-art for quantization methods, and you can find more information about the algorithm, as well as benchmarks, </span><a href="http://image.ntua.gr/iva/research/lopq/"><span style="font-weight:400;">here</span></a><span style="font-weight:400;">. Additionally, we provide an </span><a href="https://github.com/yahoo/lopq"><span style="font-weight:400;">open-source implementation</span></a><span style="font-weight:400;"> in Python and Spark which you can apply to your own datasets. The algorithm produces a set of cluster indexes that can be queried efficiently in an inverted index, as described. We have also explored use cases that use these indexes as a hash for fast deduplication of images and large-scale clustering. These extended use cases are studied </span><a href="https://arxiv.org/abs/1604.06480"><span style="font-weight:400;">here</span></a><span style="font-weight:400;">.</span></p>
<h2><span style="font-weight:400;">Conclusion</span></h2>
<p><span style="font-weight:400;">We have described our system for large-scale visual similarity search at Flickr. Techniques for producing high-quality vector representations for images with deep learning are constantly improving, enabling new ways to search and explore large multimedia collections. These techniques are being applied in other domains as well to, for example, produce vector representations for </span><a href="https://en.wikipedia.org/wiki/Word2vec"><span style="font-weight:400;">text</span></a><span style="font-weight:400;">, </span><a href="https://arxiv.org/pdf/1502.04681.pdf"><span style="font-weight:400;">video</span></a><span style="font-weight:400;">, and even </span><a href="https://arxiv.org/pdf/1603.00856.pdf"><span style="font-weight:400;">molecules</span></a><span style="font-weight:400;">. Large-scale approximate nearest neighbor search has importance and potential application in these domains as well as many others. Though these techniques are in their infancy, we hope similarity search provides a useful new way to appreciate the amazing collection of images at Flickr and surface photos of interest that may have previously gone undiscovered. We are excited about the future of this technology at Flickr and beyond.</span></p>
<p><b>Acknowledgements</b></p>
<p><span style="font-weight:400;">Yannis Kalantidis, Huy Nguyen, Stacey Svetlichnaya, Arel Cordero. Special thanks to the rest of the Computer Vision and Machine Learning team and the Vespa search team who manages Yahoo’s internal search engine.</span></p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="https://code.flickr.net/category/uncategorized/" rel="category tag">Uncategorized</a>			</span>
															<span class="sep"> | </span>
							<span class="tag-links">
				<span class="entry-utility-prep entry-utility-prep-tag-links">Tagged</span> <a href="https://code.flickr.net/tag/machine-learning/" rel="tag">machine learning</a>, <a href="https://code.flickr.net/tag/machine-tags/" rel="tag">machine tags</a>, <a href="https://code.flickr.net/tag/neural-network/" rel="tag">neural network</a>, <a href="https://code.flickr.net/tag/similarity-search/" rel="tag">similarity search</a>, <a href="https://code.flickr.net/tag/visual-similarity/" rel="tag">visual similarity</a>			</span>
						
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-3571 -->

				
					
	<article id="post-3550" class="post-3550 post type-post status-publish format-standard hentry category-uncategorized">
		<header class="entry-header">
						<h1 class="entry-title"><a href="https://code.flickr.net/2017/01/05/a-year-without-a-byte/" rel="bookmark">A Year Without a&nbsp;Byte</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="https://code.flickr.net/2017/01/05/a-year-without-a-byte/" title="1:47 am" rel="bookmark"><time class="entry-date" datetime="2017-01-05T01:47:56-07:00">January 5, 2017</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="https://code.flickr.net/author/archieflickr/" title="View all posts by Archie Russell" rel="author">Archie Russell</a></span></span>			</div><!-- .entry-meta -->
			
					</header><!-- .entry-header -->

				<div class="entry-content">
			<p>One of the largest cost drivers in running a service like Flickr is storage. We&#8217;ve described multiple techniques to get this cost down over the years: use of <a href="https://yahooeng.tumblr.com/post/116391291701/yahoo-cloud-object-store-object-storage-at">COS</a>, <a href="https://code.flickr.net/2015/06/25/real-time-resizing-of-flickr-images-using-gpus">creating sizes dynamically</a> on GPUs and <a href="https://code.flickr.net/2015/09/25/perceptual-image-compression-at-flickr/">perceptual compression</a>. These projects have been very successful, but our storage cost is still significant.<br />
At the beginning of 2016, we challenged ourselves to go further &#8212; to go a full year without needing new storage hardware. Using multiple techniques, we got there.</p>
<h2>The Cost Story</h2>
<p>A little back-of-the-envelope math shows storage costs are a real concern. On a very high-traffic day, Flickr users upload as many as twenty-five million photos. These photos require an average of 3.25 megabytes of storage each, totalling over 80 terabytes of data. Stored naively in a cloud service similar to S3, this day&#8217;s worth of data would cost over $30,000 per year, and continue to incur costs every year.</p>
<p>And a very large service will have over two hundred million active users. At a thousand images each, storage in a service similar to S3 would cost over $250 million per year (or $1.25 / user-year) plus network and other expenses. This compounds as new users sign up and existing users continue to take photos at an accelerating rate. Thankfully, our costs, and <em>every</em> large service&#8217;s costs, are different than storing naively at S3, but remain significant.</p>
<p class="figure"><img src="https://c1.staticflickr.com/1/445/32109964665_f465976673_o.png" alt="" width="800" height="600" /><br />
<span class="caption"><br />
Cost per byte have decreased, but bytes per image from iPhone-type platforms have increased. Cost per image hasn&#8217;t changed significantly.<br />
</span></p>
<p>Storage costs <em>do</em> drop over time. For example, S3 costs dropped from $0.15 per gigabyte month in 2009 to $0.03 per gigabyte-month in 2014, and cloud storage vendors have added low-cost options for data that is infrequently accessed. NAS vendors have also delivered large price reductions.</p>
<p>Unfortunately, these lower costs <em>per byte</em> are counteracted by other forces. On iPhones, increasing camera resolution, burst mode and the addition of short animations (Live Photos) have increased bytes-per-image rapidly enough to keep storage cost <em>per image</em> roughly constant. And iPhone images are far from the largest.</p>
<p>In response to these costs, photo storage services have pursued a variety of product options. To name a few: storing lower quality images or re-compressing, charging users for their data usage, incorporating advertising, selling associated products such as prints, and tying storage to purchases of handsets.</p>
<p>There are also a number of engineering approaches to controlling storage costs. We sketched out a few and cover three that we implemented below: adjusting thresholds on our storage systems, rolling out existing savings approaches to more images, and deploying lossless JPG compression.</p>
<h2>Adjusting Storage Thresholds</h2>
<p>As we dug into the problem, we looked at our storage systems in detail. We discovered that our settings were based on assumptions about high write and delete loads that didn&#8217;t hold. Our storage is pretty static. Users only rarely delete or change images once uploaded. We also had two distinct areas of just-in-case space. 5% of our storage was reserved space for snapshots, useful for undoing accidental deletes or writes, and 8.5% was held free in reserve. This resulted in about 13% of our storage going unused. Trade lore states that disks should remain 10% free to avoid performance degradation, but we found 5% to be sufficient for our workload. So we combined our our two just-in-case areas into one and reduced our free space threshold to that level. This was our simplest approach to the problem (by far), but it resulted in a large gain. With a couple simple configuration changes, we freed up more than 8% of our storage.</p>
<p class="figure"><img src="https://c1.staticflickr.com/1/267/31961928142_a5f68d8501_o.png" alt="" width="800" height="600" /><br />
<span class="caption"><br />
Adjusting storage thresholds<br />
</span></p>
<h2>Extending Existing Approaches</h2>
<p>In our earlier posts, we have described dynamic generation of thumbnail sizes and perceptual compression. Combining the two approaches decreased thumbnail storage requirements by 65%, though we hadn&#8217;t applied these techniques to many of our images uploaded prior to 2014. One big reason for this: large-scale changes to older files are inherently risky, and require significant time and engineering work to do safely.</p>
<p>Because we were concerned that further rollout of dynamic thumbnail generation would place a heavy load on our resizing infrastructure, we targeted only thumbnails from less-popular images for deletes. Using this approach, we were able to handle our complete resize load with just four GPUs. The process put a heavy load on our storage systems; to minimize the impact we randomized our operations across volumes. The entire process took about four months, resulting in even more significant gains than our storage threshold adjustments.</p>
<p class="figure"><img src="https://c1.staticflickr.com/1/315/31269155834_a74f75a611_o.png" alt="" width="800" height="600" /><br />
<span class="caption"><br />
Decreasing the number of thumbnail sizes<br />
</span></p>
<h2>Lossless JPG Compression</h2>
<p>Flickr has had a long-standing commitment to keeping uploaded images byte-for-byte intact. This has placed a floor on how much storage reduction we can do, but there are tools that can losslessly compress JPG images. Two well-known options are <a href="http://www.elektronik.htw-aalen.de/packjpg/">PackJPG</a> and <a href="https://blogs.dropbox.com/tech/2016/07/lepton-image-compression-saving-22-losslessly-from-images-at-15mbs">Lepton</a>, from Dropbox. These tools work by decoding the JPG, then very carefully compressing it using a more efficient approach. This typically shrinks a JPG by about 22%. At Flickr&#8217;s scale, this is significant. The downside is that these re-compressors use a lot of CPU. PackJPG compresses at about 2MB/s on a single core, or about fifteen core-years for a single petabyte worth of JPGs. Lepton uses multiple cores and, at 15MB/s, is much faster than packJPG, but uses roughly the same amount of CPU time.</p>
<p>This CPU requirement also complicated on-demand serving. If we recompressed all the images on Flickr, we would need potentially thousands of cores to handle our decompress load. We considered putting some restrictions on access to compressed images, such as requiring users to login to access original images, but ultimately found that if we targeted only rarely accessed private images, decompressions would occur only infrequently. Additionally, restricting the maximum size of images we compressed limited our CPU time per decompress. We rolled this out as a component of our existing serving stack without requiring any additional CPUs, and with only minor impact to user experience.</p>
<p>Running our users&#8217; original photos through lossless compression was probably our highest-risk approach. We can recreate thumbnails easily, but a corrupted source image cannot be recovered. Key to our approach was a re-compress-decompress-verify strategy: every recompressed image was decompressed and compared to its source before removing the uncompressed source image.</p>
<p>This is still a work-in-progress. We have compressed many images but to do our entire corpus is a lengthy process, and we had reached our zero-new-storage-gear goal by mid-year.</p>
<h2>On The Drawing Board</h2>
<p>We have several other ideas which we&#8217;ve investigated but haven&#8217;t implemented yet.</p>
<p>In our current storage model, we have originals and thumbnails available for every image, each stored in two datacenters. This model assumes that the images need to be viewable relatively quickly at any point in time. But private images belonging to accounts that have been inactive for more than a few months are unlikely to be accessed. We could &#8220;freeze&#8221; these images, dropping their thumbnails and recreate them when the dormant user returns. This &#8220;thaw&#8221; process would take under thirty seconds for a typical account. Additionally, for photos that are private (but not dormant), we could go to a single uncompressed copy of each thumbnail, storing a compressed copy in a second datacenter that would be decompressed as needed.</p>
<p>We might not even need two copies of each dormant original image available on disk. We&#8217;ve pencilled out a model where we place one copy on a slower, but underutilized, tape-based system while leaving the other on disk. This would decrease availability during an outage, but as these images belong to dormant users, the effect would be minimal and users would still see their thumbnails. The delicate piece here is the placement of data, as seeks on tape systems are prohibitively slow. Depending on the details of what constitutes a &#8220;dormant&#8221; photo these techniques could comfortably reduce storage used by over 25%.</p>
<p>We&#8217;ve also looked into de-duplication, but we found our duplicate rate is in the 3% range. Users do have many duplicates of their <em>own</em> images on their devices, but these are excluded by our upload tools.  We&#8217;ve also looked into using alternate image formats for our thumbnail storage.    <a href="https://developers.google.com/speed/webp/">WebP</a> can be much more compact than ordinary JPG but our use of perceptual compression gets us close to WebP byte size and permits much faster resize.  The <a href="http://bellard.org/bpg/">BPG</a> project proposes a <em>dramatically</em> smaller, H.265 based encoding but has IP and other issues.</p>
<p>There are several similar optimizations available for videos. Although Flickr is primarily image-focused, videos are typically much larger than images and consume considerably more storage.</p>
<h2>Conclusion</h2>
<p class="figure"><img src="https://c1.staticflickr.com/1/751/32071867876_1cd6466b9a_o.png" alt="" width="800" height="600" /><br />
<span class="caption"><br />
Optimization over several releases<br />
</span></p>
<p>Since 2013 we&#8217;ve optimized our usage of storage by nearly 50%.  Our latest efforts helped us get through 2016 without purchasing any additional storage,  and we still have a few more options available.</p>
<p>Peter Norby, Teja Komma, Shijo Joy and Bei Wu formed the core team for our zero-storage-budget project. Many others assisted the effort.</p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="https://code.flickr.net/category/uncategorized/" rel="category tag">Uncategorized</a>			</span>
															
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-3550 -->

				
					
	<article id="post-3453" class="post-3453 post type-post status-publish format-standard hentry category-hadoop category-infrastructure tag-personalization">
		<header class="entry-header">
						<h1 class="entry-title"><a href="https://code.flickr.net/2016/09/30/personalized-group-recommendations-on-flickr/" rel="bookmark">Personalized Group Recommendations on&nbsp;Flickr</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="https://code.flickr.net/2016/09/30/personalized-group-recommendations-on-flickr/" title="4:04 am" rel="bookmark"><time class="entry-date" datetime="2016-09-30T04:04:10-07:00">September 30, 2016</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="https://code.flickr.net/author/mehulpatel001/" title="View all posts by Mehul Patel" rel="author">Mehul Patel</a></span></span>			</div><!-- .entry-meta -->
			
					</header><!-- .entry-header -->

				<div class="entry-content">
			<p><span style="font-weight:400;">There are two primary paradigms for the discovery of digital content. First is the search paradigm, in which the user is actively looking for specific content using search terms and filters (e.g., Google </span><a href="https://www.google.com/?q=iceland"><span style="font-weight:400;">web search</span></a><span style="font-weight:400;">, Flickr </span><a href="https://www.flickr.com/search/?text=iceland&amp;dimension_search_mode=min&amp;height=1024&amp;width=1024"><span style="font-weight:400;">image search</span></a><span style="font-weight:400;">, Yelp </span><a href="https://www.yelp.com/search?find_desc=irish+pub&amp;find_loc=San+Francisco,+CA&amp;start=0&amp;attrs=RestaurantsPriceRange2.2&amp;open_now=4277"><span style="font-weight:400;">restaurant search</span></a><span style="font-weight:400;">, etc.). Second is a passive approach, in which the user browses content presented to them (e.g., NYTimes </span><a href="http://www.nytimes.com/"><span style="font-weight:400;">news</span></a><span style="font-weight:400;">, Flickr </span><a href="https://www.flickr.com/explore"><span style="font-weight:400;">Explore</span></a><span style="font-weight:400;">, and Twitter </span><a href="https://twitter.com/trendingtopics/"><span style="font-weight:400;">trending topics</span></a><span style="font-weight:400;">). Personalization benefits both approaches by providing relevant content that is tailored to users’ tastes (e.g., Google </span><a href="https://news.google.com/"><span style="font-weight:400;">News</span></a><span style="font-weight:400;">, Netflix </span><a href="https://www.netflix.com/browse"><span style="font-weight:400;">homepage</span></a><span style="font-weight:400;">, LinkedIn </span><a href="https://www.linkedin.com"><span style="font-weight:400;">job search</span></a><span style="font-weight:400;">, etc.). We believe personalization can improve the user experience at Flickr by guiding both new as well as more experienced members as they explore photography. Today, we’re excited to bring you personalized group recommendations.</span></p>
<p><span style="font-weight:400;">Flickr Groups are great for bringing people together around a common theme, be it a style of photography, camera, place, event, topic, or just some fun. Community members join for several reasons—to consume photos, to get feedback, to play games, to get more views, or to start a discussion about photos, cameras, life or the universe. We see value in connecting people with appropriate groups based on their interests. Hence, we decided to start the personalization journey by providing contextually relevant and personalized content that is tuned to each person’s unique taste. </span></p>
<p><span style="font-weight:400;">Of course, in order to respect users’ privacy, group recommendations only consider public photos and public groups. Additionally, recommendations are private to the user. In other words, nobody else sees what is recommended to an individual. </span></p>
<p><span style="font-weight:400;">In this post we describe how we are improving Flickr’s group recommendations. In particular, we describe how we are replacing a curated, non-personalized, static list of groups with a dynamic group recommendation engine that automatically generates new results based on user interactions to provide personalized recommendations unique to each person. The algorithms and backend systems we are building are broad and applicable to other scenarios, such as photo recommendations, contact recommendations, content discovery, etc.</span></p>
<p><img data-attachment-id="3463" data-permalink="https://code.flickr.net/2016/09/30/personalized-group-recommendations-on-flickr/group_recommendations2/" data-orig-file="https://flickrcode.files.wordpress.com/2016/09/group_recommendations2.png" data-orig-size="2188,1924" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="group_recommendations2" data-image-description="" data-medium-file="https://flickrcode.files.wordpress.com/2016/09/group_recommendations2.png?w=800" data-large-file="https://flickrcode.files.wordpress.com/2016/09/group_recommendations2.png?w=800" class=" size-full wp-image-3463 aligncenter" src="https://flickrcode.files.wordpress.com/2016/09/group_recommendations2.png?w=800" alt="Group_recommendations2.png" srcset="https://flickrcode.files.wordpress.com/2016/09/group_recommendations2.png?w=800 800w, https://flickrcode.files.wordpress.com/2016/09/group_recommendations2.png?w=1600 1600w, https://flickrcode.files.wordpress.com/2016/09/group_recommendations2.png?w=150 150w, https://flickrcode.files.wordpress.com/2016/09/group_recommendations2.png?w=768 768w, https://flickrcode.files.wordpress.com/2016/09/group_recommendations2.png?w=1024 1024w" sizes="(max-width: 800px) 100vw, 800px"   /></p>
<p style="text-align:center;"><b>Figure</b><span style="font-weight:400;">: Personalized group recommendations</span></p>
<h1>Challenges</h1>
<p><span style="font-weight:400;">One challenge of recommendations is determining a user’s interests. These interests could be user-specified, explicit preferences or could be inferred implicitly from their actions, supported by user feedback. For example: </span></p>
<ul>
<li style="font-weight:400;"><span style="font-weight:400;">Explicit:</span>
<ul>
<li style="font-weight:400;"><span style="font-weight:400;">Ask users what topics interest them</span></li>
<li style="font-weight:400;"><span style="font-weight:400;">Ask users why they joined a particular group</span></li>
</ul>
</li>
<li style="font-weight:400;"><span style="font-weight:400;">Implicit:</span>
<ul>
<li style="font-weight:400;"><span style="font-weight:400;">Infer user tastes from groups they join, photos they like, and users they follow</span></li>
<li style="font-weight:400;"><span style="font-weight:400;">Infer why users joined a particular group based on their activity, interactions, and dwell time</span></li>
</ul>
</li>
<li style="font-weight:400;"><span style="font-weight:400;">Feedback:</span>
<ul>
<li style="font-weight:400;"><span style="font-weight:400;">Get feedback on recommended items when users perform actions such as “Join” or “Follow” or click “Not interested”</span></li>
</ul>
</li>
</ul>
<p><span style="font-weight:400;">Another challenge of recommendations is figuring out group characteristics. I.e.: what type of group is it? What interests does it serve? What brings Flickr members to this group? We can infer this by analyzing group members, photos posted to the group, discussions and amount of activity in the group.</span></p>
<p><span style="font-weight:400;">Once we have figured out user preferences and group characteristics, recommendations essentially becomes a matchmaking process. At a high-level, we want to support 3 use cases:</span></p>
<ul>
<li style="font-weight:400;"><b>Use Case # 1</b><span style="font-weight:400;">: Given a group, return all groups that are “similar”</span></li>
<li style="font-weight:400;"><b>Use Case # 2</b><span style="font-weight:400;">: Given a user, return a list of recommended groups</span></li>
<li style="font-weight:400;"><b>Use Case # 3</b><span style="font-weight:400;">: Given a photo, return a list of groups that the photo could belong to</span></li>
</ul>
<h1>Collaborative Filtering</h1>
<p><span style="font-weight:400;">One approach to recommender systems is presenting similar content in the current context of actions. For example, Amazon’s “Customers who bought this item also bought” or LinkedIn’s “People also viewed.” Item-based collaborative filtering can be used for computing similar items.</span></p>
<p><img data-attachment-id="3457" data-permalink="https://code.flickr.net/2016/09/30/personalized-group-recommendations-on-flickr/collaborative_filtering/" data-orig-file="https://flickrcode.files.wordpress.com/2016/09/collaborative_filtering.gif" data-orig-size="498,480" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="collaborative_filtering" data-image-description="" data-medium-file="https://flickrcode.files.wordpress.com/2016/09/collaborative_filtering.gif?w=498" data-large-file="https://flickrcode.files.wordpress.com/2016/09/collaborative_filtering.gif?w=498" class="alignnone wp-image-3457 aligncenter" src="https://flickrcode.files.wordpress.com/2016/09/collaborative_filtering.gif?w=463&#038;h=447" alt="collaborative_filtering" width="463" height="447" /></p>
<p style="text-align:center;"><b>Figure</b><span style="font-weight:400;">: Collaborative filtering in action</span></p>
<p style="text-align:center;"><span style="font-weight:400;">By Moshanin (Own work) [</span><a href="http://creativecommons.org/licenses/by-sa/3.0"><span style="font-weight:400;">CC BY-SA 3.0</span></a><span style="font-weight:400;">] from </span><a href="https://upload.wikimedia.org/wikipedia/commons/5/52/Collaborative_filtering.gif"><span style="font-weight:400;">Wikipedia</span></a></p>
<p><span style="font-weight:400;">Intuitively, two groups are similar if they have the same content or same set of users. We observed that users often post the same photo to multiple groups. So, to begin, we compute group similarity based on a photo’s presence in multiple groups.  </span></p>
<p style="text-align:left;"><span style="font-weight:400;">Consider the following sample matrix </span><span style="font-weight:400;">M</span><span style="font-weight:400;">(</span><span style="font-weight:400;">G</span><span style="font-weight:400;">i</span><span style="font-weight:400;"> -&gt; </span><span style="font-weight:400;">P</span><span style="font-weight:400;">j</span><span style="font-weight:400;">) constructed from group photo pools, where 1 means a corresponding group (</span><span style="font-weight:400;">G</span><span style="font-weight:400;">i</span><span style="font-weight:400;">) contains an image, and empty (0) means a group does not contain the image.</span></p>
<p style="text-align:left;"><img data-attachment-id="3472" data-permalink="https://code.flickr.net/2016/09/30/personalized-group-recommendations-on-flickr/matrix1/" data-orig-file="https://flickrcode.files.wordpress.com/2016/09/matrix1.png" data-orig-size="569,237" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="matrix1" data-image-description="" data-medium-file="https://flickrcode.files.wordpress.com/2016/09/matrix1.png?w=569" data-large-file="https://flickrcode.files.wordpress.com/2016/09/matrix1.png?w=569" class=" size-full wp-image-3472 aligncenter" src="https://flickrcode.files.wordpress.com/2016/09/matrix1.png?w=800" alt="matrix1" srcset="https://flickrcode.files.wordpress.com/2016/09/matrix1.png 569w, https://flickrcode.files.wordpress.com/2016/09/matrix1.png?w=150 150w" sizes="(max-width: 569px) 100vw, 569px"   /></p>
<p style="text-align:left;"><span style="font-weight:400;">From this, we can compute </span><span style="font-weight:400;">M.</span><span style="font-weight:400;">M&#8217;</span> <span style="font-weight:400;">(</span><span style="font-weight:400;">M</span><span style="font-weight:400;">’s </span><a href="https://en.wikipedia.org/wiki/Transpose"><span style="font-weight:400;">transpose</span></a><span style="font-weight:400;">), which gives us the number of common photos between every pair of groups (G</span><span style="font-weight:400;">i</span><span style="font-weight:400;">, G</span><span style="font-weight:400;">j</span><span style="font-weight:400;">):</span></p>
<p style="text-align:left;"><img data-attachment-id="3535" data-permalink="https://code.flickr.net/2016/09/30/personalized-group-recommendations-on-flickr/matrix2-2/" data-orig-file="https://flickrcode.files.wordpress.com/2016/09/matrix21.png" data-orig-size="512,182" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="matrix2" data-image-description="" data-medium-file="https://flickrcode.files.wordpress.com/2016/09/matrix21.png?w=512" data-large-file="https://flickrcode.files.wordpress.com/2016/09/matrix21.png?w=512" class="size-full wp-image-3535 aligncenter" src="https://flickrcode.files.wordpress.com/2016/09/matrix21.png?w=800" alt="matrix2" srcset="https://flickrcode.files.wordpress.com/2016/09/matrix21.png 512w, https://flickrcode.files.wordpress.com/2016/09/matrix21.png?w=150 150w" sizes="(max-width: 512px) 100vw, 512px"   /></p>
<p><span style="font-weight:400;">We use modified </span><a href="https://en.wikipedia.org/wiki/Cosine_similarity"><span style="font-weight:400;">cosine similarity</span></a><span style="font-weight:400;"> to compute a similarity score between every pair of groups: </span></p>
<p style="text-align:center;"><img data-attachment-id="3536" data-permalink="https://code.flickr.net/2016/09/30/personalized-group-recommendations-on-flickr/cosinesimilarity-2/" data-orig-file="https://flickrcode.files.wordpress.com/2016/09/cosinesimilarity1.png" data-orig-size="337,59" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="cosinesimilarity" data-image-description="" data-medium-file="https://flickrcode.files.wordpress.com/2016/09/cosinesimilarity1.png?w=337" data-large-file="https://flickrcode.files.wordpress.com/2016/09/cosinesimilarity1.png?w=337" class="alignnone size-full wp-image-3536" src="https://flickrcode.files.wordpress.com/2016/09/cosinesimilarity1.png?w=800" alt="cosinesimilarity" srcset="https://flickrcode.files.wordpress.com/2016/09/cosinesimilarity1.png 337w, https://flickrcode.files.wordpress.com/2016/09/cosinesimilarity1.png?w=150 150w" sizes="(max-width: 337px) 100vw, 337px"   /></p>
<p><span style="font-weight:400;">To make this calculation robust, we only consider groups that have a minimum of X photos and keep only strong relationships (i.e., groups that have at least Y common photos). Finally, we use the similarity scores to come up with the top k-nearest neighbors for each group. </span></p>
<p><span style="font-weight:400;">We also compute group similarity based on group membership —i.e., by defining group-user relationship (G</span><span style="font-weight:400;">i</span><span style="font-weight:400;"> -&gt; U</span><span style="font-weight:400;">j</span><span style="font-weight:400;">) matrix. It is interesting to note that the results obtained from this relationship are very different compared to (G</span><span style="font-weight:400;">i</span><span style="font-weight:400;">, P</span><span style="font-weight:400;">j</span><span style="font-weight:400;">) matrix. The group-photo relationship tends to capture groups that are similar by content (e.g.,“macro photography”). On the other hand, the group-user relationship gives us groups that the same users have joined but are possibly about very different topics, thus providing us with a diversity of results. We can extend this approach by computing group similarity using other features and relationships (e.g., autotags of photos to cluster groups by themes, geotags of photos to cluster groups by place, frequency of discussion to cluster groups by interaction model, etc.).</span></p>
<p><span style="font-weight:400;">Using this we can easily come up with a list of similar groups (Use Case # 1). We can either merge the results obtained by different similarity relationships into a single result set, or keep them separate to power features like “Other groups similar to this group” and “People who joined this group also joined.”</span></p>
<p><span style="font-weight:400;">We can also use the same data for recommending groups to users (Use Case # 2). We can look at all the groups that the user has already joined and recommend groups similar to those. </span></p>
<p><span style="font-weight:400;">To come up with a list of relevant groups for a photo (Use Case # 3), we can compute photo similarity either by using a similar approach as above or by using Flickr computer vision models for finding photos similar to the query photo. A simple approach would then be to recommend groups that these similar photos belong to.</span></p>
<h1>Implementation</h1>
<p><span style="font-weight:400;">Due to the massive scale (millions of users x 100k groups) of data, we used </span><a href="http://yahoohadoop.tumblr.com/"><span style="font-weight:400;">Yahoo’s Hadoop Stack</span></a><span style="font-weight:400;"> to implement the collaborative filtering algorithm. We exploited sparsity of entity-item relationship matrices to come up with a more efficient model of computation and used several optimizations for computational efficiency. We only need to compute the similarity model once every 7 days, since signals change slowly. </span></p>
<p><img data-attachment-id="3537" data-permalink="https://code.flickr.net/2016/09/30/personalized-group-recommendations-on-flickr/architecture_diagram-2/" data-orig-file="https://flickrcode.files.wordpress.com/2016/09/architecture_diagram1.jpg" data-orig-size="800,600" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="architecture_diagram" data-image-description="" data-medium-file="https://flickrcode.files.wordpress.com/2016/09/architecture_diagram1.jpg?w=800" data-large-file="https://flickrcode.files.wordpress.com/2016/09/architecture_diagram1.jpg?w=800" class=" wp-image-3537 aligncenter" src="https://flickrcode.files.wordpress.com/2016/09/architecture_diagram1.jpg?w=507&#038;h=383" alt="architecture_diagram" width="507" height="383" /></p>
<p style="text-align:center;"><b>Figure</b><span style="font-weight:400;">: Computational architecture</span></p>
<p style="text-align:center;"><span style="font-weight:400;">(All logos and icons are trademarks of respective entities)</span></p>
<p>&nbsp;</p>
<p><span style="font-weight:400;">Similarity scores and top k-nearest neighbors for each group are published to </span><a href="http://redis.io/"><span style="font-weight:400;">Redis</span></a><span style="font-weight:400;"> for quick lookups needed by the serving layer. Recommendations for each user are computed in real-time when the user visits the </span><a href="https://www.flickr.com/groups"><span style="font-weight:400;">groups</span></a><span style="font-weight:400;"> page. Implementation of the serving layer takes care of a few aspects that are important from usability and performance point-of-view:</span></p>
<ul>
<li style="font-weight:400;"><b>Freshness of results</b><span style="font-weight:400;">: Users hate to see the same results being offered even though they might be relevant. We have implemented a randomization scheme that returns fresh results every X hours, while making sure that results stay static over a user’s single session.</span></li>
<li style="font-weight:400;"><b>Diversity of results</b><span style="font-weight:400;">: Diversity of results in recommendations is very important since a user might not want to join a group that is very similar to a group he’s already involved in. We require a good threshold that balances similarity and diversity. To improve diversity further, we combine recommendations from different algorithms. We also cluster the user’s groups into diverse sets before computing recommendations.</span></li>
<li style="font-weight:400;"><b>Dynamic results</b><span style="font-weight:400;">: Users expect their interactions to have a quick effect on recommendations. We thus incorporate user interactions while making subsequent recommendations so that the system feels dynamic.</span></li>
<li style="font-weight:400;"><b>Performance</b><span style="font-weight:400;">: Recommendation results are cached so that API response is quick on subsequent visits. </span></li>
</ul>
<h1>Cold Start</h1>
<p><span style="font-weight:400;">The drawback to collaborative filtering is that it cannot offer recommendations to new users who do not have any associations. For these users, we plan to recommend groups from an algorithmically computed list of top/trending groups alongside manual curation. As users interact with the system by joining groups, the recommendations become more personalized.</span></p>
<h1>Measuring Effectiveness</h1>
<p><span style="font-weight:400;">We use qualitative feedback from user studies and alpha group testing to understand user expectation and to guide initial feature design. However, for continued algorithmic improvements, we need an objective quantitative metric. Recommendation results by their very nature are subjective, so measuring effectiveness is tricky. The usual approach taken is to roll out to a random population of users and measure the outcome of interest for the test group as compared to the control group (ref: </span><a href="https://en.wikipedia.org/wiki/A/B_testing"><span style="font-weight:400;">A/B testing</span></a><span style="font-weight:400;">). </span></p>
<p><span style="font-weight:400;">We plan to employ this technique and measure user interaction and engagement to keep improving the recommendation algorithms. Additionally, we plan to measure explicit signals such as when users click “Not interested.” This feedback will also be used to fine-tune future recommendations for users.</span></p>
<p><img data-attachment-id="3538" data-permalink="https://code.flickr.net/2016/09/30/personalized-group-recommendations-on-flickr/measuringeffectiveness-2/" data-orig-file="https://flickrcode.files.wordpress.com/2016/09/measuringeffectiveness1.png" data-orig-size="2110,920" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="measuringeffectiveness" data-image-description="" data-medium-file="https://flickrcode.files.wordpress.com/2016/09/measuringeffectiveness1.png?w=800" data-large-file="https://flickrcode.files.wordpress.com/2016/09/measuringeffectiveness1.png?w=800" class="size-medium wp-image-3538 aligncenter" src="https://flickrcode.files.wordpress.com/2016/09/measuringeffectiveness1.png?w=800&#038;h=349" alt="measuringeffectiveness" width="800" height="349" srcset="https://flickrcode.files.wordpress.com/2016/09/measuringeffectiveness1.png?w=800&amp;h=349 800w, https://flickrcode.files.wordpress.com/2016/09/measuringeffectiveness1.png?w=1600&amp;h=698 1600w, https://flickrcode.files.wordpress.com/2016/09/measuringeffectiveness1.png?w=150&amp;h=65 150w, https://flickrcode.files.wordpress.com/2016/09/measuringeffectiveness1.png?w=768&amp;h=335 768w, https://flickrcode.files.wordpress.com/2016/09/measuringeffectiveness1.png?w=1024&amp;h=446 1024w" sizes="(max-width: 800px) 100vw, 800px" /></p>
<p style="text-align:center;"><b>Figure</b><span style="font-weight:400;">: Measuring user engagement</span></p>
<h1>Future Directions</h1>
<p><span style="font-weight:400;">While we’re seeing good initial results, we’d like to continue improving the algorithms to provide better results to the Flickr community. Potential future directions can be classified broadly into 3 buckets: algorithmic improvements, new product use cases, and new recommendation applications.</span></p>
<p><i><span style="font-weight:400;">If you’d like to help, we’re hiring. Check out our </span></i><a href="https://www.flickr.com/jobs"><i><span style="font-weight:400;">jobs page</span></i></a><i><span style="font-weight:400;"> and get in touch.</span></i></p>
<p><b><i>Product Engineering</i></b><i><span style="font-weight:400;">: Mehul Patel, Chenfan (Frank) Sun,  Chinmay Kini</span></i></p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="https://code.flickr.net/category/hadoop/" rel="category tag">hadoop</a>, <a href="https://code.flickr.net/category/infrastructure/" rel="category tag">infrastructure</a>			</span>
															<span class="sep"> | </span>
							<span class="tag-links">
				<span class="entry-utility-prep entry-utility-prep-tag-links">Tagged</span> <a href="https://code.flickr.net/tag/personalization/" rel="tag">personalization</a>			</span>
						
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-3453 -->

				
					
	<article id="post-3432" class="post-3432 post type-post status-publish format-standard hentry category-uncategorized tag-careers tag-jobs">
		<header class="entry-header">
						<h1 class="entry-title"><a href="https://code.flickr.net/2016/05/11/we-want-you-and-your-teammates/" rel="bookmark">We Want You&#8230; and Your&nbsp;Teammates</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="https://code.flickr.net/2016/05/11/we-want-you-and-your-teammates/" title="8:19 pm" rel="bookmark"><time class="entry-date" datetime="2016-05-11T20:19:40-07:00">May 11, 2016</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="https://code.flickr.net/author/xanthet/" title="View all posts by Xanthe Travlos" rel="author">Xanthe Travlos</a></span></span>			</div><!-- .entry-meta -->
			
					</header><!-- .entry-header -->

				<div class="entry-content">
			<p><a href="https://www.flickr.com/jobs"><span style="font-weight:400;"><img data-attachment-id="3436" data-permalink="https://code.flickr.net/2016/05/11/we-want-you-and-your-teammates/14493569810_7ac064e3c4_o/" data-orig-file="https://flickrcode.files.wordpress.com/2016/05/14493569810_7ac064e3c4_o.jpg" data-orig-size="9208,2420" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;2.2&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;iPhone 5s&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;1405616427&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;4.12&quot;,&quot;iso&quot;:&quot;160&quot;,&quot;shutter_speed&quot;:&quot;0.0059171597633136&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;1&quot;}" data-image-title="14493569810_7ac064e3c4_o" data-image-description="" data-medium-file="https://flickrcode.files.wordpress.com/2016/05/14493569810_7ac064e3c4_o.jpg?w=800" data-large-file="https://flickrcode.files.wordpress.com/2016/05/14493569810_7ac064e3c4_o.jpg?w=800" class="size-medium wp-image-3436 aligncenter" src="https://flickrcode.files.wordpress.com/2016/05/14493569810_7ac064e3c4_o.jpg?w=800&#038;h=210" alt="14493569810_7ac064e3c4_o" width="800" height="210" srcset="https://flickrcode.files.wordpress.com/2016/05/14493569810_7ac064e3c4_o.jpg?w=800&amp;h=210 800w, https://flickrcode.files.wordpress.com/2016/05/14493569810_7ac064e3c4_o.jpg?w=1598&amp;h=420 1598w, https://flickrcode.files.wordpress.com/2016/05/14493569810_7ac064e3c4_o.jpg?w=150&amp;h=39 150w, https://flickrcode.files.wordpress.com/2016/05/14493569810_7ac064e3c4_o.jpg?w=768&amp;h=202 768w, https://flickrcode.files.wordpress.com/2016/05/14493569810_7ac064e3c4_o.jpg?w=1024&amp;h=269 1024w" sizes="(max-width: 800px) 100vw, 800px" /></span></a><a href="https://www.flickr.com/jobs"><span style="font-weight:400;">We&#8217;re hiring here at Flickr</span></a><span style="font-weight:400;"> and we got pretty excited the other week when we saw Stripe’s post: </span><a href="https://stripe.com/blog/bring-your-own-team"><span style="font-weight:400;">BYOT (Bring Your Own Team)</span></a><span style="font-weight:400;">. The sum of the parts is greater than the whole and all that. Genius &lt;big hat tip to them&gt;.</span></p>
<p><span style="font-weight:400;">In case you didn’t read Stripe’s post, here’s the gist: you’re a team player, you like to make an impact, focus on a tough problem, set a challenging goal, and see the fruits of your labor after blood, sweat, and tears (or, maybe just brainpower). But you’ve got the itch to collaborate, to talk an idea through, break it down, and parallelize tasks or simply to be around your mates through work and play. Turns out you already have your go-to group of colleagues, roommates, siblings, or buddies that push, inspire, and get the best out of you. Well, in that case we may want to hire all of you! </span></p>
<p><span style="font-weight:400;">Like Stripe, we understand the importance of team dynamics. So if you’ve already got something good going on, we want in on it too. We love Stripe and are stoked for this initiative of theirs, but if Flickr tickles your fancy (and it does ours :) consider bringing that team of yours this way too, especially if you’ve got a penchant for mobile development. We’d love to chat! </span></p>
<p><span style="font-weight:400;">Email us: jobs at flickr.com</span></p>
<p><img data-attachment-id="3445" data-permalink="https://code.flickr.net/2016/05/11/we-want-you-and-your-teammates/team-crop/" data-orig-file="https://flickrcode.files.wordpress.com/2016/05/team-crop.jpg" data-orig-size="1200,746" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;2.2&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;iPhone 6&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;1431107979&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;4.15&quot;,&quot;iso&quot;:&quot;50&quot;,&quot;shutter_speed&quot;:&quot;0.033333333333333&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;1&quot;}" data-image-title="Team crop" data-image-description="" data-medium-file="https://flickrcode.files.wordpress.com/2016/05/team-crop.jpg?w=800" data-large-file="https://flickrcode.files.wordpress.com/2016/05/team-crop.jpg?w=800" class="alignnone size-medium wp-image-3445" src="https://flickrcode.files.wordpress.com/2016/05/team-crop.jpg?w=800&#038;h=497" alt="Team crop" width="800" height="497" srcset="https://flickrcode.files.wordpress.com/2016/05/team-crop.jpg?w=800&amp;h=497 800w, https://flickrcode.files.wordpress.com/2016/05/team-crop.jpg?w=150&amp;h=93 150w, https://flickrcode.files.wordpress.com/2016/05/team-crop.jpg?w=768&amp;h=477 768w, https://flickrcode.files.wordpress.com/2016/05/team-crop.jpg?w=1024&amp;h=637 1024w, https://flickrcode.files.wordpress.com/2016/05/team-crop.jpg 1200w" sizes="(max-width: 800px) 100vw, 800px" /></p>
<p>Photos by: <a href="https://www.flickr.com/photos/cjmartin/14493569810/in/photolist-o5KkmE-s1Ab2X-oB9Jcz-r6894C-8UE9qs-nUiqdZ-nUD1T8-nSeAva-pu3e82-pEYdJy-rtfXVi-pAY9az-6qsxHF-nTFAd6-p3U1U1-qqhDn3-qY2QhS-or84zJ-osKqkn-qhnbAv-r5mmHv-ejKoBB-rASeqq-ejKp2H-qJV7kr-en2Lwp-oqgHNq-qsiNCQ-gKdheW-qDW829-o3RLfK-rw8To2-qbYAJC-nMYHBp-q4sajA-s3j5Ec-rj62WB-rxW8je-r31xGH-rqTqsT-occV8T-pRUg6U-en2L4a-p4R7rj-6cMnzR-oF16rb-7QBcD1-5XH2Yb-5XdwzJ-qjBx4n'">@Chris Martin</a> and <a href="https://www.flickr.com/photos/superic/17255895320/in/photolist-shQYuy-4y4vxZ-fqd5ou-dLQWLM">@Captain Eric Willis</a></p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="https://code.flickr.net/category/uncategorized/" rel="category tag">Uncategorized</a>			</span>
															<span class="sep"> | </span>
							<span class="tag-links">
				<span class="entry-utility-prep entry-utility-prep-tag-links">Tagged</span> <a href="https://code.flickr.net/tag/careers/" rel="tag">careers</a>, <a href="https://code.flickr.net/tag/jobs/" rel="tag">jobs</a>			</span>
						
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-3432 -->

				
					
	<article id="post-3394" class="post-3394 post type-post status-publish format-standard hentry category-api-2 category-open-source tag-api tag-javascript tag-node-js">
		<header class="entry-header">
						<h1 class="entry-title"><a href="https://code.flickr.net/2016/04/25/introducing-yakbak-record-and-playback-http-interactions-in-nodejs/" rel="bookmark">Introducing yakbak: Record and playback HTTP interactions in&nbsp;NodeJS</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="https://code.flickr.net/2016/04/25/introducing-yakbak-record-and-playback-http-interactions-in-nodejs/" title="7:22 pm" rel="bookmark"><time class="entry-date" datetime="2016-04-25T19:22:18-07:00">April 25, 2016</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="https://code.flickr.net/author/jeremyruppel/" title="View all posts by jeremyruppel" rel="author">jeremyruppel</a></span></span>			</div><!-- .entry-meta -->
			
					</header><!-- .entry-header -->

				<div class="entry-content">
			<p><b></b><span style="font-weight:400;">Did you know that the new Front End of <a href="https://www.flickr.com" target="_blank">www.flickr.com</a> is one big Flickr API client? Writing a client for an existing API or service can be a lot of fun, but decoupling and testing that client can be quite tricky. There are many different approaches to taking the backing service out of the equation when it comes to writing tests for client code. Today we&#8217;ll discuss the pros and cons of some of these approaches, describe how the Flickr Front End team tests service-dependent libraries, and introduce you to our new NodeJS HTTP playback module: </span><a href="https://github.com/flickr/yakbak"><span style="font-weight:400;">yakbak</span></a><span style="font-weight:400;">!</span></p>
<p><b>Scenario: Testing a Flickr API Client</b></p>
<p><span style="font-weight:400;">Let&#8217;s jump into some code, shall we? Suppose we&#8217;re testing a (very, very simple) photo search API client:</span></p>
<style>.gist table { margin-bottom: 0; }</style>
<div class="gist-oembed" data-gist="fd25c723a5962a49936f174d765aa11a.json"></div>
<p><span style="font-weight:400;">Currently, this code will make an HTTP request to the Flickr API on every test run. This is less than desirable for several reasons:</span></p>
<ul>
<li style="font-weight:400;"><a href="https://en.wikipedia.org/wiki/User-generated_content"><i><span style="font-weight:400;">UGC</span></i></a><i><span style="font-weight:400;"> is unpredictable</span></i><span style="font-weight:400;">. In this test, we&#8217;re asserting that the response code is an HTTP 200, but obviously our client code needs to provide the response data to be useful. It&#8217;s impossible to write a meaningful and predictable test against live content.</span></li>
<li style="font-weight:400;"><i><span style="font-weight:400;">Traffic is unpredictable</span></i><span style="font-weight:400;">. This photos search API call usually takes ~150ms for simple queries, but a more complex query or a call during peak traffic may take longer.</span></li>
<li style="font-weight:400;"><i><span style="font-weight:400;">Downtime is unpredictable</span></i><span style="font-weight:400;">. Every service has downtime (the term is </span><a href="https://en.wikipedia.org/wiki/High_availability"><span style="font-weight:400;">&#8220;four nines,&#8221;</span></a><span style="font-weight:400;"> not &#8220;one hundred percent&#8221; for a reason), and if your service is down, your client tests will fail.</span></li>
<li style="font-weight:400;"><i><span style="font-weight:400;">Networks are unpredictable</span></i><span style="font-weight:400;">. Have you ever tried coding on a plane? Enough said.</span></li>
</ul>
<p><span style="font-weight:400;">We want our test suite to be consistent, predictable, and fast. We’re also only trying to test our client code, not the API. Let’s take a look at some ways to replace the API with a control, allowing us to predictably test the client code.</span></p>
<p><b>Approach 1: Stub the HTTP client methods</b></p>
<p><span style="font-weight:400;">We’re using </span><a href="https://github.com/visionmedia/superagent"><span style="font-weight:400;">superagent</span></a><span style="font-weight:400;"> as our HTTP client, so we could use a mocking library like </span><a href="http://sinonjs.org/"><span style="font-weight:400;">sinon</span></a><span style="font-weight:400;"> to stub out superagent’s Request methods:</span></p>
<style>.gist table { margin-bottom: 0; }</style>
<div class="gist-oembed" data-gist="8b837f439663db325aaa2437a2259934.json"></div>
<p><span style="font-weight:400;">With these changes, we never actually make an HTTP request to the API during a test run. Now our test is predictable, controlled, and it runs </span><b>crazy fast</b><span style="font-weight:400;">. However, this approach has some major drawbacks:</span></p>
<ul>
<li style="font-weight:400;"><i><span style="font-weight:400;">Tightly coupled with superagent.</span></i><span style="font-weight:400;"> We’re all up in the client’s implementation details here, so if superagent ever changes their API, we’ll need to correct our tests to match. Likewise, if we ever want to use a different HTTP client, we’ll need to correct our tests as well.</span></li>
<li style="font-weight:400;"><i><span style="font-weight:400;">Difficult to specify the full HTTP response</span></i><span style="font-weight:400;">. Here we’re only specifying the </span><span style="font-weight:400;">statusCode</span><span style="font-weight:400;">; what about when we need to specify the body or the headers? Talk about verbose.</span></li>
<li style="font-weight:400;"><i><span style="font-weight:400;">Not necessarily accurate</span></i><span style="font-weight:400;">. We’re trusting the test author to provide a fake response that matches what the actual server would send back. What happens if the API changes the response schema? Some unhappy developer will have to manually update the tests to match reality (probably an intern, let’s be honest).</span></li>
</ul>
<p><span style="font-weight:400;">We’ve at least managed to replace the service with a control in our tests, but we can do (slightly) better.</span></p>
<p><b>Approach 2: Mock the NodeJS HTTP module</b></p>
<p><span style="font-weight:400;">Every NodeJS HTTP client will eventually delegate to the standard NodeJS http module to perform the network request. This means we can intercept the request at a low level by using a tool like </span><a href="https://www.npmjs.com/package/nock"><span style="font-weight:400;">nock</span></a><span style="font-weight:400;">:</span></p>
<style>.gist table { margin-bottom: 0; }</style>
<div class="gist-oembed" data-gist="d92a62400f635b42249adc041cdecc96.json"></div>
<p><span style="font-weight:400;">Great! We’re no longer stubbing out superagent and we can still control the HTTP response. This avoids the HTTP client coupling from the previous step, but still has many similar drawbacks:</span></p>
<ul>
<li style="font-weight:400;"><span style="font-weight:400;">We’re still completely implementation-dependent. If we want to pass a new query string parameter to our service, for example, we’ll also need to add it to the test so that nock will match the request.</span></li>
<li style="font-weight:400;"><span style="font-weight:400;">It’s still laborious to specify the response headers, body, etc.</span></li>
<li style="font-weight:400;"><span style="font-weight:400;">It’s still difficult to make sure the response body always matches reality.</span></li>
</ul>
<p><span style="font-weight:400;">At this point, it’s worth noting that none of these bullet points were an issue back when we were actually making the HTTP request. So, let’s do exactly that (once!).</span></p>
<p><b>Approach 3: Record and playback the HTTP interaction</b></p>
<p><span style="font-weight:400;">The Ruby community created the excellent </span><a href="https://github.com/vcr/vcr"><span style="font-weight:400;">VCR</span></a><span style="font-weight:400;"> gem for recording and replaying HTTP interactions during tests. Recorded HTTP requests exist as “tapes”, which are just files with some sort of format describing the interaction. The basic workflow goes like this:</span></p>
<ol>
<li style="font-weight:400;"><span style="font-weight:400;">The client makes an actual HTTP request.</span></li>
<li style="font-weight:400;"><span style="font-weight:400;">VCR sits in front of the system’s HTTP library and intercepts the request.</span></li>
<li style="font-weight:400;"><span style="font-weight:400;">If VCR has a tape matching the request, it simply replays the response to the client.</span></li>
<li style="font-weight:400;"><span style="font-weight:400;">Otherwise, VCR lets the HTTP request through to the service, records the interaction to a new tape on disk and plays it back to the client.</span></li>
</ol>
<p><b>Introducing yakbak</b></p>
<p><span style="font-weight:400;">Today we’re open-sourcing </span><a href="https://github.com/flickr/yakbak"><span style="font-weight:400;">yakbak</span></a><span style="font-weight:400;">, our take on recording and playing back HTTP interactions in NodeJS. Here’s what our tests look like with a yakbak proxy:</span></p>
<style>.gist table { margin-bottom: 0; }</style>
<div class="gist-oembed" data-gist="7050b34342a10d8e3dd8bc2dba0d50c0.json"></div>
<p>Here we’ve created a standard NodeJS http.Server with our proxy middleware. We’ve also configured our client to point to the proxy server instead of the origin service. Look, no implementation details!</p>
<p>yakbak tries to do things The Node Way™ wherever possible. For example, each yakbak “tape” is actually its own module that simply exports an http.Server handler, which <span style="font-weight:400;">allows us to do some really cool things. For example, it’s trivial to create a server that always responds a certain way. Since the tape’s hash is based solely on the incoming request, we can easily edit the response however we like. We’re also kicking around a </span><a href="https://github.com/flickr/yakbak/issues?q=is%3Aopen+is%3Aissue+label%3Aenhancement"><span style="font-weight:400;">handful of enhancements</span></a><span style="font-weight:400;"> that should make yakbak an even more powerful development tool. </span></p>
<p><span style="font-weight:400;">Thanks to yakbak, we’ve been writing fast, consistent, and reliable tests for our HTTP clients and applications. Want to give it a spin? Check it out today: </span><a href="https://github.com/flickr/yakbak"><span style="font-weight:400;">https://github.com/flickr/yakbak</span></a></p>
<p><b>P.S. We’re hiring!</b></p>
<p><span style="font-weight:400;">Do you love development tooling and helping keep teams on the latest and greatest technology? Or maybe you just want to help build the best home for your photos on the entire internet? </span><a href="https://www.flickr.com/jobs"><span style="font-weight:400;">We’re hiring Front End Ops</span></a><span style="font-weight:400;"> and tons of other great positions. We’d love to hear from you!</span></p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="https://code.flickr.net/category/api-2/" rel="category tag">API</a>, <a href="https://code.flickr.net/category/open-source/" rel="category tag">open source</a>			</span>
															<span class="sep"> | </span>
							<span class="tag-links">
				<span class="entry-utility-prep entry-utility-prep-tag-links">Tagged</span> <a href="https://code.flickr.net/tag/api/" rel="tag">api</a>, <a href="https://code.flickr.net/tag/javascript/" rel="tag">javascript</a>, <a href="https://code.flickr.net/tag/node-js/" rel="tag">node.js</a>			</span>
						
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-3394 -->

				
					
	<article id="post-3370" class="post-3370 post type-post status-publish format-standard hentry category-open-source">
		<header class="entry-header">
						<h1 class="entry-title"><a href="https://code.flickr.net/2016/04/05/our-justified-layout-goes-open-source/" rel="bookmark">Our Justified Layout Goes Open&nbsp;Source</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="https://code.flickr.net/2016/04/05/our-justified-layout-goes-open-source/" title="5:01 pm" rel="bookmark"><time class="entry-date" datetime="2016-04-05T17:01:53-07:00">April 5, 2016</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="https://code.flickr.net/author/jimwhimpey/" title="View all posts by jimwhimpey" rel="author">jimwhimpey</a></span></span>			</div><!-- .entry-meta -->
			
					</header><!-- .entry-header -->

				<div class="entry-content">
			<p><span style="font-weight:400;">We introduced the justified layout on Flickr.com late in 2011. Our community of photographers loved it for its ability to efficiently display many photos at their native aspect ratio with visually pleasing, consistent whitespace, so we quickly added it to the rest of the website.</span></p>
<p><a href="https://www.flickr.com/photos/onlywhenchased/albums/72157625187496924"><img data-attachment-id="3315" data-permalink="https://code.flickr.net/?attachment_id=3315" data-orig-file="https://flickrcode.files.wordpress.com/2016/02/screen-shot-2016-02-22-at-5-00-07-pm.png" data-orig-size="805,244" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Optimal Twemproxy/Redis Architecture" data-image-description="" data-medium-file="https://flickrcode.files.wordpress.com/2016/02/screen-shot-2016-02-22-at-5-00-07-pm.png?w=800" data-large-file="https://flickrcode.files.wordpress.com/2016/02/screen-shot-2016-02-22-at-5-00-07-pm.png?w=800" class="alignnone size-full wp-image-3315" src="https://cloud.githubusercontent.com/assets/43693/14259021/e4aede8e-fa59-11e5-9fca-bf86ae5bc2e1.png" alt="Justified Example" width="805" height="244" /></a></p>
<p><span style="font-weight:400;">It&#8217;s been through many iterations and optimizations. From back when we were primarily on the </span><a href="https://code.flickr.net/2013/06/"><span style="font-weight:400;">PHP stack</span></a><span style="font-weight:400;"> to our lovely new JavaScript based isomorphic stack. Last year Eric Socolofsky did </span><a href="https://code.flickr.net/2015/03/24/much-photos/"><span style="font-weight:400;">a great job explaining how the algorithm works</span></a><span style="font-weight:400;"> and how it fits into a larger infrastructure for Flickr specifically.</span></p>
<p><span style="font-weight:400;">In the years following its launch, we&#8217;ve had requests from our front end colleagues in other teams across Yahoo for a reusable package that does photo (or any rectangle) presentation like this, but it&#8217;s always been too tightly coupled to our stack to separate it out and hand it over. Until now! Today we&#8217;re publishing the </span><a href="http://flickr.github.io/justified-layout/"><span style="font-weight:400;">justified-layout algorithm wrapped in an npm module</span></a><span style="font-weight:400;"> for you to use on the server, or client, in your own projects.</span></p>
<h2><b>Install/Download</b></h2>
<pre><span style="font-weight:400;">npm install justified-layout --save</span></pre>
<p><span style="font-weight:400;">Or grab it directly </span><a href="https://github.com/flickr/justified-layout"><span style="font-weight:400;">from Github</span></a><span style="font-weight:400;">.</span></p>
<h2><b>Using it</b></h2>
<p><span style="font-weight:400;">It’s really easy to use. No configuration is required. Just pass in an array of aspect ratios representing the photos/boxes you&#8217;d like to lay out:</span></p>
<pre><span style="font-weight:400;">var layoutGeometry = require('justified-layout')([1.33, 1, 0.65] [, config]);</span></pre>
<p><span style="font-weight:400;">If you only have dimensions and don&#8217;t want an extra step to convert them to aspect ratios, you can pass in an array of widths and heights like this:</span></p>
<style>.gist table { margin-bottom: 0; }</style>
<div class="gist-oembed" data-gist="825377b78ef8d9b10e702aa6adc41eb4.json"></div>
<h2><b>What it returns</b></h2>
<p><span style="font-weight:400;">The geometry data for the layout items, in the same order they’re passed in.</span></p>
<style>.gist table { margin-bottom: 0; }</style>
<div class="gist-oembed" data-gist="faaf2c95809647abcbea481d8445ecf9.json"></div>
<p><span style="font-weight:400;">This is the extent of what the module provides. There&#8217;s no rendering component. It&#8217;s up to you to use this data to render boxes the way you want. Use absolute positioning, background positions, canvas, generate a static image on the backend, whatever you like! There&#8217;s a very basic implementation used on </span><a href="https://github.com/flickr/justified-layout/blob/gh-pages/index.html#L21-L33"><span style="font-weight:400;">the demo and docs page</span></a><span style="font-weight:400;">.</span></p>
<h2><b>Configuration</b></h2>
<p><span style="font-weight:400;">It&#8217;s highly likely the defaults don&#8217;t satisfy your requirements; they don&#8217;t even satisfy ours. There&#8217;s a full set of configuration options to customize the output just the way you want. My favorite is the </span><span style="font-weight:400;">fullWidthBreakoutRowCadence</span><span style="font-weight:400;"> option that we use </span><a href="https://www.flickr.com/photos/cameron_obscura/sets/72157651385352366"><span style="font-weight:400;">on album pages</span></a><span style="font-weight:400;">. All config options are documented on the </span><a href="http://flickr.github.io/justified-layout/#options"><span style="font-weight:400;">docs and demo page</span></a><span style="font-weight:400;">.</span></p>
<h2><b>Compatibility</b></h2>
<ul>
<li style="font-weight:400;"><span style="font-weight:400;">Latest Chrome</span></li>
<li style="font-weight:400;"><span style="font-weight:400;">Latest Safari</span></li>
<li style="font-weight:400;"><span style="font-weight:400;">Latest Firefox</span></li>
<li style="font-weight:400;"><span style="font-weight:400;">Latest Mobile Safari</span></li>
<li style="font-weight:400;"><span style="font-weight:400;">IE 9+</span></li>
<li style="font-weight:400;"><span style="font-weight:400;">Node 0.10+</span></li>
</ul>
<h2><b>The future</b></h2>
<p><span style="font-weight:400;">The justified layout algorithm is just one part of our photo list infrastructure. Following this, we&#8217;ll be open sourcing more modules for handling data, handling state, reverse layouts, appending and prepending items for pagination. </span></p>
<p><span style="font-weight:400;">We welcome your feedback, issues and contributions </span><a href="https://github.com/flickr/justified-layout"><span style="font-weight:400;">on Github</span></a><span style="font-weight:400;">.</span></p>
<h2><b>P.S. Open Source at Flickr</b></h2>
<p><span style="font-weight:400;">This is the first of quite a bit of code we have in the works for open source release. If working on open source projects appeals to you, </span><a href="https://www.flickr.com/jobs/"><span style="font-weight:400;">we&#8217;re hiring</span></a><span style="font-weight:400;">!</span></p>
<p>&nbsp;</p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="https://code.flickr.net/category/open-source/" rel="category tag">open source</a>			</span>
															
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-3370 -->

				
					
	<article id="post-3319" class="post-3319 post type-post status-publish format-standard hentry category-uncategorized">
		<header class="entry-header">
						<h1 class="entry-title"><a href="https://code.flickr.net/2016/03/24/configuration-management-for-distributed-systems-using-github-and-cfg4j/" rel="bookmark">Configuration management for distributed systems (using GitHub and&nbsp;cfg4j)</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="https://code.flickr.net/2016/03/24/configuration-management-for-distributed-systems-using-github-and-cfg4j/" title="4:39 am" rel="bookmark"><time class="entry-date" datetime="2016-03-24T04:39:31-07:00">March 24, 2016</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="https://code.flickr.net/author/norbertpotocki/" title="View all posts by norbertpotocki" rel="author">norbertpotocki</a></span></span>			</div><!-- .entry-meta -->
			
					</header><!-- .entry-header -->

				<div class="entry-content">
			<p><i>Norbert Potocki, Software Engineer @ Yahoo Inc.</i></p>
<h2><b>Warm up: <i>Why configuration management?</i></b></h2>
<p>When working with large-scale software systems, configuration management becomes crucial; supporting non-uniform environments gets greatly simplified if you decouple code from configuration. While building complex software/products such as <a href="https://www.flickr.com/">Flickr</a>, we had to come up with a simple, yet powerful, way to manage configuration. Popular approaches to solving this problem include using configuration files or having a dedicated configuration service. Our new solution combines the extremely popular <a href="http://github.com/">GitHub</a> and <a href="http://www.cfg4j.org/">cfg4j</a> library, giving you a very flexible approach that will work with applications of any size.</p>
<h4><b>Why should I decouple configuration from the code?</b></h4>
<ul>
<li>Faster configuration changes (e.g. flipping feature toggles): Configuration can simply be injected without requiring parts of your code to be reloaded and re-executed. Config-only updates tend to be faster than code deployment.</li>
<li>Different configuration for different environments: Running your app on a laptop or in a test environment requires a different set of settings than production instance.</li>
<li>Keeping credentials private: If you don’t have a dedicated credential store, it may be convenient to keep credentials as part of configuration. They usually aren’t supposed to be “public,” but the code still may be. Be a good sport and don&#8217;t keep credentials in a public GitHub repo. :)</li>
</ul>
<h2><b>Meet the Gang: <i>Overview of configuration management players</i></b></h2>
<p>Let’s see what configuration-specific components we’ll be working with today:</p>
<figure class="tmblr-full"><img class=" aligncenter" src="https://56.media.tumblr.com/33746f4780ff5e56d99c88e77e44e163/tumblr_inline_o47joy3QLn1t3d6pa_540.png" alt="image" /><figcaption><i> <small>Figure 1 &#8211;  Overview of configuration management components</small><br />
</i></figcaption></figure>
<p><i>Configuration repository and editor</i>: Where your configuration lives. We&#8217;re using <a href="https://git-scm.com/">Git</a> for storing configuration files and <a href="http://github.com/">GitHub</a> as an ad hoc editor.</p>
<p><i>Push cache </i>: Intermediary store that we use to improve fetch speed and to ease load on GitHub servers.</p>
<p><i>CD pipeline</i>: Continuous deployment pipeline pushing changes from repository to push cache, and validating config correctness.</p>
<p><i>Configuration library</i>: Fetches configs from push cache and exposing them to your business logic.</p>
<p><i>Bootstrap configuration </i>: Initial configuration specifying where your push cache is (so that library knows where to get configuration from).</p>
<p>All these players work as a team to provide an end-to-end configuration management solution.</p>
<h4><b>The Coach: <i>Configuration repository and editor</i></b></h4>
<p>The first thing you might expect from the configuration repository and editor is ease of use. Let’s enumerate what that means:</p>
<ul>
<li>Configuration should be easy to read and write.</li>
<li>It should be straightforward to add a new configuration set.</li>
<li>You most certainly want to be able to review changes if your team is bigger than one person.</li>
<li>It’s nice to see a history of changes, especially when you’re trying to fix a bug in the middle of the night.</li>
<li>Support from popular IDEs &#8211; freedom of choice is priceless.</li>
<li>Multi-tenancy support (optional) is often pragmatic.</li>
</ul>
<p>So what options are out there that may satisfy those requirements? The three very popular formats for storing configuration are <a href="http://yaml.org/">YAML</a>, Java Property files, and XML files. We use YAML &#8211; it is widely supported by multiple programming languages and IDEs, and it’s very readable and easy to understand, even by a non-engineer.</p>
<p>We could use a dedicated configuration store; however, the great thing about files is that they can be easily versioned by version control tools like Git, which we decided to use as it’s widely known and proven.</p>
<p>Git provides us with a history of changes and an easy way to branch off configuration. It also has great support in the form of GitHub which we use both as an editor (built-in support for YAML files) and collaboration tool (pull requests, forks, review tool). Both are nicely glued together by following the<a href="http://nvie.com/posts/a-successful-git-branching-model/"> Git flow branching model.</a> Here’s an example of a configuration file that we use:</p>
<figure class="tmblr-full"><img class=" aligncenter" src="https://56.media.tumblr.com/23132e30bc9ea96dc7a6dd21d1125a7a/tumblr_inline_o47m8ne6iT1t3d6pa_540.png" alt="" /><figcaption><i> <small>Figure 2 &#8211;  configuration file preview</small><br />
</i></figcaption></figure>
<p>One of the goals was to make managing multiple configuration sets (execution environments) a breeze. We need the ability to add and remove environments quickly. If you look at the screenshot below, you’ll notice a “prod-us-east” directory in the path. For every environment, we store a separate directory with config files in Git. All of them have the exact same structure and only differ in YAML file contents.</p>
<p>This solution makes working with environments simple and comes in very handy during local development or new production fleet rollout (see use cases at the end of this article). Here’s a sample config repo for a project that has only one “feature”:</p>
<figure class="tmblr-full"><img class=" aligncenter" src="https://56.media.tumblr.com/06b1f785bb828923d6cd2b82f4b9f100/tumblr_inline_o47medL5NH1t3d6pa_540.png" alt="" /><figcaption><i><small>Figure 3 &#8211;  support for multiple environments</small><br />
</i></figcaption></figure>
<p>Some of the products that we work with at Yahoo have a very granular architecture with hundreds of micro-services working together. For scenarios like this, it’s convenient to store configurations for all services in a single repository. It greatly reduces the overhead of maintaining multiple repositories. We support this use case by having multiple top-level directories, each holding configurations for one service only.</p>
<h4><b>The sprinter: <i>Push cache</i></b></h4>
<p>The main role of push cache is to decrease the load put on the GitHub server and improve configuration fetch time. Since speed is the only concern here, we decided to keep the push cache simple: it’s just a key-value store. <a href="http://consul.io/">Consul</a> was our choice, in part because it’s fully distributed.</p>
<p>You can install Consul clients on the edge nodes and they will keep being synchronized across the fleet. This greatly improves both the reliability and the performance of the system. If performance is not a concern, any key-value store will do. You can skip using push cache altogether and connect directly to Github, which comes in handy during development (see use cases to learn more about this).</p>
<h4><b>The Manager: <i>CD Pipeline</i></b></h4>
<p>When the configuration repository is updated, a CD pipeline kicks in. This fetches configuration, converts it into a more optimized format, and pushes it to cache. Additionally, the CD pipeline validates the configuration (once at pull-request stage and again after being merged to master) and controls multi-phase deployment by deploying config change to only 20% of production hosts at one time.</p>
<h4><b>The Mascot: <i>Bootstrap configuration</i></b></h4>
<p>Before we can connect to the push cache to fetch configuration, we need to know where it is. That’s where bootstrap configuration comes into play. It’s very simple. The config contains the hostname, port to connect to, and the name of the environment to use. You need to put this config with your code or as part of the CD pipeline. This simple yaml file binding Spring profiles to different Consul hosts suffices for our needs:</p>
<figure class="tmblr-full"><img class=" aligncenter" src="https://56.media.tumblr.com/738020b5614fc06a26b85d2dc13789ad/tumblr_inline_o47k33QdkU1t3d6pa_540.png" alt="image" /><figcaption><i><small>Figure 4 &#8211;  bootstrap configuration<br />
</small><br />
</i></figcaption></figure>
<h4><b>The Cool Guy: <i>Configuration library</i></b></h4>
<figure><img class=" aligncenter" src="https://56.media.tumblr.com/1370245b95cb98f542762a8040c6bf50/tumblr_inline_o47k4bgxl51t3d6pa_540.png" alt="image" /></figure>
<p>The configuration library takes care of fetching the configuration from push cache and exposing it to your business logic. We use the library called <a href="http://www.cfg4j.org/">cfg4j</a> (&#8220;configuration for java&#8221;). This library re-loads configurations from the push cache every few seconds and injects them into configuration objects that our code uses. It also takes care of local caching, merging properties from different repositories, and falling back to user-provided defaults when necessary (read more at <a href="http://www.cfg4j.org/">http://www.cfg4j.org/</a>).</p>
<p>Briefly summarizing how we use cfg4j’s features:</p>
<ul>
<li>Configuration auto-reloading: Each service reloads configuration every ~30 seconds and auto re-configures itself.</li>
<li>Multi-environment support: for our multiple environments (beta, performance, canary, production-us-west, production-us-east, etc.).</li>
<li>Local caching: Remedies service interruption when the push cache or configuration repository is down and also improves the performance for obtaining configs.</li>
<li>Fallback and merge strategies: Simplifies local development and provides support for multiple configuration repositories.</li>
<li>Integration with Dependency Injection containers &#8211; because we love DI!</li>
</ul>
<p>If you want to play with this library yourself, there’s plenty of examples both in<a href="http://www.cfg4j.org/"> its documentation</a> and<a href="https://github.com/cfg4j/cfg4j-sample-apps"> cfg4j-sample-apps Github repository</a>.</p>
<h4><b>The Heavy Lifter: <i>Configurable code</i></b></h4>
<p>The most important piece is business logic. To best make use of a configuration service, the business logic has to be able to re-configure itself in runtime. Here are a few rules of thumb and code samples:<b><br />
</b></p>
<ul>
<li>Use dependency injection for injecting configuration. This is how we do it using Spring Framework (see the bootstrap configuration above for host/port values):</li>
</ul>
<style>.gist table { margin-bottom: 0; }</style>
<div class="gist-oembed" data-gist="e91aa64b524592432630.json"></div>
<ul>
<li>Use configuration objects to inject configuration instead of providing configuration directly &#8211; here’s where the difference is:</li>
</ul>
<p>Direct configuration injection (won’t reload as config changes)</p>
<style>.gist table { margin-bottom: 0; }</style>
<div class="gist-oembed" data-gist="eac0a927ca2df45c2a0b.json"></div>
<p>Configuration injection via “interface binding” (will reload as config changes):</p>
<style>.gist table { margin-bottom: 0; }</style>
<div class="gist-oembed" data-gist="0c0b5b9aa9d11c06c937.json"></div>
<h2><b>The exercise: <i>Common use-cases (applying our simple solution)</i></b></h2>
<h4><b>Configuration during development (local overrides)</b></h4>
<p>When you develop a feature, a main concern is the ability to evolve your code quickly.  A full configuration-management pipeline is not conducive to this. We use the following approaches when doing local development:<b><br />
</b></p>
<ul>
<li>Add a temporary configuration file to the project and use cfg4j&#8217;s <i>MergeConfigurationSource</i> for reading config both from the configuration store and your file. By making your local file a primary configuration source, you provide an override mechanism. If the property is found in your file, it will be used. If not, cfg4j will fall back to using values from configuration store. Here’s an example (reference examples above to get a complete code):</li>
</ul>
<style>.gist table { margin-bottom: 0; }</style>
<div class="gist-oembed" data-gist="289f3943249ea2813dcf.json"></div>
<ul>
<li>Fork the configuration repository, make changes to the fork and use cfg4j&#8217;s GitConfigurationSource to access it directly (no push<br />
cache required):</li>
</ul>
<style>.gist table { margin-bottom: 0; }</style>
<div class="gist-oembed" data-gist="dacdcc6671a2158ded5e.json"></div>
<ul>
<li>Set up your private push cache, point your service to the cache, and edit values in it directly.</li>
</ul>
<h4><b>Configuration defaults</b></h4>
<p>When you work with multiple environments, some of them may share a configuration. That’s when using configuration defaults may be convenient. You can do this by creating a “default” environment and using cfg4j&#8217;s MergeConfigurationSource for reading config first from the original environment and then (as a fallback) from “default” environment.</p>
<h4><b>Dealing with outages</b></h4>
<p>Configuration repository, push cache, and configuration CD pipeline can experience outages. To minimize the impact of such events, it’s good practice to cache configuration locally (in-memory) after each fetch. cfg4j does that automatically.</p>
<h4><b>Responding to incidents &#8211; ultra fast configuration updates (skipping configuration CD pipeline)</b></h4>
<p>Tests can’t always detect all problems. Bugs leak to the production environment and at times it’s important to make a config change as fast as possible to stop the fire. If you’re using push cache, the fastest way to modify config values is to make changes directly within the cache. Consul offers a rich REST API and web ui for updating configuration in the key-value store.</p>
<h4><b>Keeping code and configuration in sync</b></h4>
<p>Verifying that code and configuration are kept in sync happens at the configuration CD pipeline level. One part of the continuous deployment process deploys the code into a temporary execution environment, and points it to the branch that contains the configuration changes. Once the service is up, we execute a batch of functional tests to verify configuration correctness.</p>
<h2><b>The cool down: <i>Summary</i></b></h2>
<p>The presented solution is the result of work that we put into building huge-scale photo-serving services. We needed a simple, yet flexible, configuration management system. Combining <a href="https://git-scm.com/">Git</a>, <a href="https://github.com/">Github</a>, <a href="http://consul.io/">Consul</a> and <a href="http://www.cfg4j.org/">cfg4j</a> provided a very satisfactory solution that we encourage you to try.</p>
<p><i>I want to thank the following people for reviewing this article: <b>Bhautik Joshi, Elanna Belanger, Archie Russell</b>.</i></p>
<p>PS. You can also follow me on <a href="https://twitter.com/norbert_potocki">Twitter</a>, <a href="https://github.com/norbertpotocki">GitHub</a>, <a href="https://www.linkedin.com/in/norbertpotocki">LinkedIn</a> or <a href="http://potocki.io/post/141230472743/configuration-management-for-distributed-systems">my private blog</a>.</p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="https://code.flickr.net/category/uncategorized/" rel="category tag">Uncategorized</a>			</span>
															
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-3319 -->

				
					
	<article id="post-3281" class="post-3281 post type-post status-publish format-standard hentry category-labs category-metrics category-search tag-science">
		<header class="entry-header">
						<h1 class="entry-title"><a href="https://code.flickr.net/2015/12/22/32-days-of-christmas/" rel="bookmark">The 32 Days Of&nbsp;Christmas!</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="https://code.flickr.net/2015/12/22/32-days-of-christmas/" title="10:45 pm" rel="bookmark"><time class="entry-date" datetime="2015-12-22T22:45:03-07:00">December 22, 2015</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="https://code.flickr.net/author/aymanshamma/" title="View all posts by Jofish, John, Ayman in Labs and Frank in UXR" rel="author">Jofish, John, Ayman in Labs and Frank in UXR</a></span></span>			</div><!-- .entry-meta -->
			
					</header><!-- .entry-header -->

				<div class="entry-content">
			<p><a data-flickr-embed="true" href="https://www.flickr.com/photos/kwl/6471898925/" title="LEGO City Advent Calendar - Day 7 by kennymatic, on Flickr"><img src="https://farm8.staticflickr.com/7017/6471898925_0635fb3fff_z.jpg" width="640" height="426" alt="LEGO City Advent Calendar - Day 7"></a><script async src="https://embedr.flickr.com/assets/client-code.js" charset="utf-8"></script></p>
<p>When you have thousands of photos, it can be hard to find the photo you’re looking for. Want to search for that Christmas cat you saw at last year’s party? And what if that party wasn’t on Christmas day, but sometime the week before?  To help improve the search ranking and relevance of national, personal, and religious holiday photos, we first have to see when the photos were taken; when, for example, is the <em>Christmas season</em>?</p>
<p>Understanding what people are looking for when they search for their own photos is an important part of improving Flickr. Earlier this year, we began a study (which will be published at <a href="http://chi2016.acm.org/wp/">CHI 2016</a> under the same name as this post) by trying to understand how people searched for their personal photos. We showed a group of 74 participants roughly 20 of their own photos on Flickr, and asked them what they’d put into the Flickr search box to find those photos. We did this a total of 1492 times.</p>
<p>It turns out 12% of the time people used a <i>temporal</i> term in searches for their own photos, meaning a word connected to time in some way. These might include a year (2015), a month (January), a season (winter), or a holiday or special event (Thanksgiving, Eid al-Fitr, Easter, Passover, Burning Man). Often, however, the date and time on the photograph didn’t match the search term: the year would be wrong, or people would search for a photograph of snow the weekend after Thanksgiving with the word “winter,” despite the fact that winter doesn’t officially begin until December 21st in the U.S. So we wanted to understand that situation: <b>how often does <i>fall</i> feel like <i>winter</i>?</b></p>
<p>To answer this, we mapped 78.8 million Flickr photos tagged with a season name to the date the photo was actually taken.</p>
<p><img data-attachment-id="3285" data-permalink="https://code.flickr.net/2015/12/22/32-days-of-christmas/f1-seasons/" data-orig-file="https://flickrcode.files.wordpress.com/2015/12/f1-seasons.png" data-orig-size="1368,368" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Seasons Tagged by Date" data-image-description="" data-medium-file="https://flickrcode.files.wordpress.com/2015/12/f1-seasons.png?w=800" data-large-file="https://flickrcode.files.wordpress.com/2015/12/f1-seasons.png?w=800" class="alignleft size-medium wp-image-3285" src="https://flickrcode.files.wordpress.com/2015/12/f1-seasons.png?w=800&#038;h=215" alt="Seasons Tagged by Date" width="800" height="215" srcset="https://flickrcode.files.wordpress.com/2015/12/f1-seasons.png?w=800&amp;h=215 800w, https://flickrcode.files.wordpress.com/2015/12/f1-seasons.png?w=150&amp;h=40 150w, https://flickrcode.files.wordpress.com/2015/12/f1-seasons.png?w=768&amp;h=207 768w, https://flickrcode.files.wordpress.com/2015/12/f1-seasons.png?w=1024&amp;h=275 1024w, https://flickrcode.files.wordpress.com/2015/12/f1-seasons.png 1368w" sizes="(max-width: 800px) 100vw, 800px" /></p>
<p>As you’d expect<b>, most of the photographs tagged with a season are taken during that season: 66% of photos tagged “winter” were taken between December 22 and March 20.</b> About 9% of search words are off by two seasons: photos tagged “summer” that were taken between December 21st and March 20th, for example. We expect this may reflect antipodean seasons: while most Flickr users are in the Northern Hemisphere, it doesn’t seem unreasonable that 5% of “summer” photographs might have been taken in the Southern Hemisphere. More interesting, we think, are the off-by-one cases, like fall photographs labeled as &#8220;winter,&#8221; where we believe that the photo represents the experience of winter, regardless of the objective reality of the calendar. For example, if it snows the day after Thanksgiving, it definitely feels like winter.</p>
<p>On the topic of Thanksgiving, let’s look at photographs tagged &#8220;thanksgiving.&#8221;</p>
<p><img data-attachment-id="3287" data-permalink="https://code.flickr.net/2015/12/22/32-days-of-christmas/f2-thanksgiving/" data-orig-file="https://flickrcode.files.wordpress.com/2015/12/f2-thanksgiving.png" data-orig-size="1168,868" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Percentage of Photos Tagged &#8220;Thanksgiving&#8221;" data-image-description="" data-medium-file="https://flickrcode.files.wordpress.com/2015/12/f2-thanksgiving.png?w=800" data-large-file="https://flickrcode.files.wordpress.com/2015/12/f2-thanksgiving.png?w=800" class="alignleft size-medium wp-image-3287" src="https://flickrcode.files.wordpress.com/2015/12/f2-thanksgiving.png?w=800&#038;h=595" alt="Percentage of Photos Tagged &quot;Thanksgiving&quot;" width="800" height="595" srcset="https://flickrcode.files.wordpress.com/2015/12/f2-thanksgiving.png?w=800&amp;h=595 800w, https://flickrcode.files.wordpress.com/2015/12/f2-thanksgiving.png?w=150&amp;h=111 150w, https://flickrcode.files.wordpress.com/2015/12/f2-thanksgiving.png?w=768&amp;h=571 768w, https://flickrcode.files.wordpress.com/2015/12/f2-thanksgiving.png?w=1024&amp;h=761 1024w, https://flickrcode.files.wordpress.com/2015/12/f2-thanksgiving.png 1168w" sizes="(max-width: 800px) 100vw, 800px" /><br />
The six days between November 22nd and 27th&mdash;the darkest blue area&mdash;cover 65% of the photos. Expanding that range to November 15–30th covers 83%. Expanding to all of November covers 85%, and including October (and thus Canadian Thanksgiving, in gray in early October) brings the total to 90%. But that means that 10% of all photos tagged &#8220;thanksgiving&#8221; are outside of this range. Every date in that image represents a total of a minimum of 40 photographs taken on that day between 2003 and 2014 inclusive, uploaded to Flickr and tagged &#8220;thanksgiving&#8221; with the only white spaces being days that don&#8217;t exist, like February 30th or April 31st. Manual verification of some of the public photos tagged &#8220;thanksgiving&#8221; on arbitrarily chosen dates finds these photographs tagged &#8220;thanksgiving&#8221; included pumpkins or turkeys, autumnal leaves or cornucopias&mdash;all images culturally associated with the holiday.</p>
<p><b>Not all temporal search terms are quite so complicated;</b> some holidays are celebrated and photographed on a single day each year, like <a href="https://en.wikipedia.org/wiki/Canada_Day">Canada Day</a> (July 1st) or <a href="https://en.wikipedia.org/wiki/Boxing_Day">Boxing Day</a> (December 26th). While these holidays can be easily translated to date queries, other holidays have more complicated temporal patterns. Have a look at these lunar holidays.</p>
<p><img data-attachment-id="3289" data-permalink="https://code.flickr.net/2015/12/22/32-days-of-christmas/f3-lunar/" data-orig-file="https://flickrcode.files.wordpress.com/2015/12/f3-lunar.png" data-orig-size="1368,1168" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Lunar Holidays Tagged by Date" data-image-description="" data-medium-file="https://flickrcode.files.wordpress.com/2015/12/f3-lunar.png?w=800" data-large-file="https://flickrcode.files.wordpress.com/2015/12/f3-lunar.png?w=800" class="alignleft size-medium wp-image-3289" src="https://flickrcode.files.wordpress.com/2015/12/f3-lunar.png?w=800&#038;h=683" alt="Lunar Holidays Tagged by Date" width="800" height="683" srcset="https://flickrcode.files.wordpress.com/2015/12/f3-lunar.png?w=800&amp;h=683 800w, https://flickrcode.files.wordpress.com/2015/12/f3-lunar.png?w=150&amp;h=128 150w, https://flickrcode.files.wordpress.com/2015/12/f3-lunar.png?w=768&amp;h=656 768w, https://flickrcode.files.wordpress.com/2015/12/f3-lunar.png?w=1024&amp;h=874 1024w, https://flickrcode.files.wordpress.com/2015/12/f3-lunar.png 1368w" sizes="(max-width: 800px) 100vw, 800px" /></p>
<p>There are some events that occur on a lunar calendar like Chinese New Year, Easter, Eid (both al-Fitr and al-Adha), and Hanukkah. These events move around in a regular, algorithmically determinable, but sometimes complicated, way. Most of these holidays tend to oscillate as a leap calculation is added periodically to synchronize the lunar timing to the solar calendar. However Eids, on the <a href="https://en.wikipedia.org/wiki/Islamic_calendar">Hijri calendar</a>, have no such leap correction, and we see photos tagged &#8220;Eid&#8221; edge forward year after year.</p>
<p>Some holidays and events, like birthdays, happen on every day of the week. But they’re often <i>celebrated</i>, and thus photographed, on Friday, Saturday, and Sunday:</p>
<p><img data-attachment-id="3290" data-permalink="https://code.flickr.net/2015/12/22/32-days-of-christmas/f4-birthday/" data-orig-file="https://flickrcode.files.wordpress.com/2015/12/f4-birthday.png" data-orig-size="868,168" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Day of the week tagged Birthday" data-image-description="" data-medium-file="https://flickrcode.files.wordpress.com/2015/12/f4-birthday.png?w=800" data-large-file="https://flickrcode.files.wordpress.com/2015/12/f4-birthday.png?w=800" class="alignleft size-medium wp-image-3290" src="https://flickrcode.files.wordpress.com/2015/12/f4-birthday.png?w=800&#038;h=155" alt="Day of the week tagged Birthday" width="800" height="155" srcset="https://flickrcode.files.wordpress.com/2015/12/f4-birthday.png?w=800&amp;h=155 800w, https://flickrcode.files.wordpress.com/2015/12/f4-birthday.png?w=150&amp;h=29 150w, https://flickrcode.files.wordpress.com/2015/12/f4-birthday.png?w=768&amp;h=149 768w, https://flickrcode.files.wordpress.com/2015/12/f4-birthday.png 868w" sizes="(max-width: 800px) 100vw, 800px" /></p>
<p>So to get back to our original question: when are photos tagged &#8220;Christmas&#8221; actually taken?</p>
<p><img data-attachment-id="3291" data-permalink="https://code.flickr.net/2015/12/22/32-days-of-christmas/f5-christmas/" data-orig-file="https://flickrcode.files.wordpress.com/2015/12/f5-christmas.png" data-orig-size="1168,868" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Days tagged with Christmas" data-image-description="" data-medium-file="https://flickrcode.files.wordpress.com/2015/12/f5-christmas.png?w=800" data-large-file="https://flickrcode.files.wordpress.com/2015/12/f5-christmas.png?w=800" class="alignleft size-medium wp-image-3291" src="https://flickrcode.files.wordpress.com/2015/12/f5-christmas.png?w=800&#038;h=595" alt="Days tagged with Christmas" width="800" height="595" srcset="https://flickrcode.files.wordpress.com/2015/12/f5-christmas.png?w=800&amp;h=595 800w, https://flickrcode.files.wordpress.com/2015/12/f5-christmas.png?w=150&amp;h=111 150w, https://flickrcode.files.wordpress.com/2015/12/f5-christmas.png?w=768&amp;h=571 768w, https://flickrcode.files.wordpress.com/2015/12/f5-christmas.png?w=1024&amp;h=761 1024w, https://flickrcode.files.wordpress.com/2015/12/f5-christmas.png 1168w" sizes="(max-width: 800px) 100vw, 800px" /></p>
<p>As you can see, more photos tagged &#8220;Christmas&#8221; are taken on December 25th than on any other day (19%). Christmas Eve is a close second, at 12%. If you look at other languages, this difference practically goes away: 9.2% of photos tagged “Noel” are taken on Christmas Eve, and 9.6% are taken on Christmas; “navidad” photos are 11.3% on Christmas Eve and 12.0% on Christmas. But Christmas photos are taken throughout December. We can now set a threshold for a definition of Christmas: say if at least 1% of the photos tagged “Christmas” were taken on that day, we’d rank it more relevant. That means that every day from December 1st to January 1st hits that definition, with December 2nd barely scraping in. That makes…32 days of Christmas!</p>
<p><em><strong>Merry Christmas and Happy Holidays</strong></em>—for all the holidays you celebrate and photograph.</p>
<p>PS: <a href="https://www.flickr.com/jobs">Flickr is hiring</a>! <a href="https://labs.yahoo.com/careers">Labs is hiring</a>! Come join us!</p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="https://code.flickr.net/category/labs/" rel="category tag">labs</a>, <a href="https://code.flickr.net/category/metrics/" rel="category tag">metrics</a>, <a href="https://code.flickr.net/category/search/" rel="category tag">search</a>			</span>
															<span class="sep"> | </span>
							<span class="tag-links">
				<span class="entry-utility-prep entry-utility-prep-tag-links">Tagged</span> <a href="https://code.flickr.net/tag/science/" rel="tag">science</a>			</span>
						
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-3281 -->

				
					
	<article id="post-3238" class="post-3238 post type-post status-publish format-standard hentry category-uncategorized">
		<header class="entry-header">
						<h1 class="entry-title"><a href="https://code.flickr.net/2015/11/18/flickrs-experience-with-ios-9/" rel="bookmark">Flickr&#8217;s experience with iOS&nbsp;9</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="https://code.flickr.net/2015/11/18/flickrs-experience-with-ios-9/" title="6:00 am" rel="bookmark"><time class="entry-date" datetime="2015-11-18T06:00:47-07:00">November 18, 2015</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="https://code.flickr.net/author/rocirs/" title="View all posts by Rocir Santiago" rel="author">Rocir Santiago</a></span></span>			</div><!-- .entry-meta -->
			
					</header><!-- .entry-header -->

				<div class="entry-content">
			<p>In the last couple of months, Apple has released new features as part of iOS 9 that allow a deeper integration between apps and the operating system. Among those features are Spotlight Search integration, Universal Links, and 3D Touch for iPhone 6S and iPhone 6S Plus.</p>
<p>Here at Flickr, we have added support for these new features and we have learned a few lessons that we would love to share.</p>
<h2><strong>Spotlight Search</strong></h2>
<p>There are two different kinds of content that can be searched through Spotlight: the kind that you explicitly index, and the kind that gets indexed based on the state your app is in. To explicitly index content, you use Core Spotlight, which lets you index multiple items at once. To index content related to your app’s current state, you use NSUserActivity: when a piece of content becomes visible, you start an activity to make iOS aware of this fact. iOS can then determine which pieces of content are more frequently visited, and thus more relevant to the user. NSUserActivity also allows us to mark certain items as public, which means that they might be shown to other iOS users as well.</p>
<p>For a better user experience, we index as much useful information as we can right off the bat. We prefetch all the user&#8217;s albums, groups, and people they follow, and add them to the search index using Core Spotlight. Indexing an item looks like this:</p>
<pre class="brush: objc; title: ; notranslate" title="">
// Create the attribute set, which encapsulates the metadata of the item we're indexing
CSSearchableItemAttributeSet *attributeSet = [[CSSearchableItemAttributeSet alloc] initWithItemContentType:(NSString *)kUTTypeImage];
attributeSet.title = photo.title;
attributeSet.contentDescription = photo.searchableDescription;
attributeSet.keywords = photo.keywords;
attributeSet.thumbnailData = UIImageJPEGRepresentation(photo.thumbnail, 0.98);

// Create the searchable item and index it.
CSSearchableItem *searchableItem = [[CSSearchableItem alloc] initWithUniqueIdentifier:[NSString stringWithFormat:@&quot;%@/%@&quot;, photo.identifier, photo.searchContentType] domainIdentifier:@&quot;FLKCurrentUserSearchDomain&quot; attributeSet:attributeSet];
[[CSSearchableIndex defaultSearchableIndex] indexSearchableItems:@[ searchableItem ] completionHandler:^(NSError * _Nullable error) {
                       if (error) {
                           // Handle failures.
                       }
              }];
</pre>
<p>Since we have multiple kinds of data &#8211; photos, albums, and groups &#8211; we had to create an identifier that is a combination of its type and its actual model ID.</p>
<p>Many users will have a large amount of data to be fetched, so it&#8217;s important that we take measures to make sure that the app still performs well. Since searching is unlikely to happen right after the user opens the app (that&#8217;s when we start prefetching this data, if needed), all this work is performed by a low-priority NSOperationQueue. If we ever need to fetch images to be used as thumbnails, we request it with low-priority <code>NSURLSessionDownloadTask</code>. These kinds of measures ensure that we don&#8217;t affect the performance of any operation or network request triggered by user actions, such as fetching new images and pages when scrolling through content.</p>
<p>Flickr provides a huge amount of public content, including many amazing photos. If anybody searches for &#8220;Northern Lights&#8221; in Spotlight, shouldn&#8217;t we show them our best Aurora Borealis photos? For this public content &#8211; photos, public groups, tags and so on &#8211; we leverage NSUserActivity, with its new search APIs, to make it all searchable when viewed. Here&#8217;s an example:</p>
<pre class="brush: objc; title: ; notranslate" title="">
CSSearchableItemAttributeSet *attributeSet = [[CSSearchableItemAttributeSet alloc] initWithItemContentType:(NSString *) kUTTypeImage];
// Setup attributeSet the same way we did before...
// Set the related unique identifier, so it matches to any existing item indexed with Core Spotlight.     
attributeSet.relatedUniqueIdentifier = [NSString stringWithFormat:@&quot;%@/%@&quot;, photo.identifier, photo.searchContentType];
        
self.userActivity = [[NSUserActivity alloc] initWithActivityType:@&quot;FLKSearchableUserActivityType&quot;];
self.userActivity.title = photo.title;
self.userActivity.keywords = [NSSet setWithArray:photo.keywords];
self.userActivity.webpageURL = photo.photoPageURL;
self.userActivity.contentAttributeSet = attributeSet;
self.userActivity.eligibleForSearch = YES;
self.userActivity.eligibleForPublicIndexing = photo.isPublic;
self.userActivity.requiredUserInfoKeys = [NSSet setWithArray:self.userActivity.userInfo.allKeys];
        
[self.userActivity becomeCurrent];
</pre>
<p>Every time a user opens a photo, public group, location page, etc., we create a new NSUserActivity and make it current. The more often a specific activity is made current, the more relevant iOS considers it. In fact, the more often an activity is made current by any number of different users, the more relevant Apple considers it globally, and the more likely it will show up for other iOS users as well (provided it’s public).</p>
<p>Until now we’ve only seen half the picture. We’ve seen how to index things for Spotlight search; when a user finally does search and taps on a result, how do we take them to the right place in our app? We’ll get to this a bit later, but for now suffice it to say that you’ll get a call to the method <code>application:continueUserActivity:restorationHandler:</code> to our application delegate.</p>
<p>It&#8217;s important to note that if we wanted to make use of the <code>userInfo</code> in the <code>NSUserActivity</code>, iOS won&#8217;t give it back to you for free in this method. To get it, we have to make sure that we assigned an NSSet to the <code>requiredUserInfoKeys</code> property of our <code>NSUserActivity</code> when we created it. In their documentation, Apple also tells us that if you set the <code>webpageURL</code> property when <code>eligibleForSearch</code> is <code>YES</code>, you need to make sure that you’re pointing to the right web URL corresponding to your content, otherwise you might end up with duplicate results in Spotlight (Apple crawls your site for content to surface in Spotlight, and if it finds the same content at a different URL it’ll think it’s a different piece of content).</p>
<h2><strong>Universal Links</strong></h2>
<p>In order to support Universal Links, Apple requires that every domain supported by the app host an &#8220;apple-app-site-association&#8221; file at its root. This is a JSON file that describes which relative paths in your domains can be handled by the app. When a user taps a link from another app in iOS, if your app is able to handle that domain for a specific path, it will open your app and call <code>application:continueUserActivity:restorationHandler:</code>. Otherwise your application won’t be opened &#8211; Safari will handle the URL instead.</p>
<pre class="brush: plain; title: ; notranslate" title="">
{
    &quot;applinks&quot;: {
        &quot;apps&quot;: [],
        &quot;details&quot;: {
            &quot;XXXXXXXXXX.com.some.flickr.domain&quot;: {
                &quot;paths&quot;: [
                    &quot;/&quot;,
                    &quot;/photos/*&quot;,
                    &quot;/people/*&quot;,
                    &quot;/groups/*&quot;
                ]
            }
        }
    }
}
</pre>
<p>This file has to be hosted on HTTPS with a valid certificate. Its MIME type needs to be &#8220;application/pkcs7-mime.&#8221; No redirects are allowed when requesting the file. If the only intent is to support Universal Links, no further steps are required. But if you’re also using this file to support Handoffs (introduced in iOS 8), then your file has to be CMS signed by a valid TLS certificate.</p>
<p>In Flickr, we have a few different domains. That means that each one of flickr.com, <a href="http://www.flickr.com" rel="nofollow">http://www.flickr.com</a>, m.flickr.com and flic.kr must provide its own JSON association file, whether or not they differ. In our case, the flic.kr domain actually does support different paths, since it’s only used for short URLs; hence, its &#8220;apple-app-site-association&#8221; is different than the others.</p>
<p>On the client side, only a few steps are required to support Universal Links. First, “Associated Domains” must be enabled under the Capabilities tab of the app’s target settings. For each supported domain, an entry &#8220;applinks:&#8221; entry must be added. Here is how it looks for Flickr:</p>
<p><img data-attachment-id="3272" data-permalink="https://code.flickr.net/2015/11/18/flickrs-experience-with-ios-9/screen-shot-2015-10-28-at-2-00-59-pm/" data-orig-file="https://flickrcode.files.wordpress.com/2015/11/screen-shot-2015-10-28-at-2-00-59-pm.png" data-orig-size="755,181" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Screen Shot 2015-10-28 at 2.00.59 PM" data-image-description="" data-medium-file="https://flickrcode.files.wordpress.com/2015/11/screen-shot-2015-10-28-at-2-00-59-pm.png?w=755" data-large-file="https://flickrcode.files.wordpress.com/2015/11/screen-shot-2015-10-28-at-2-00-59-pm.png?w=755" class="aligncenter size-full wp-image-3272" src="https://flickrcode.files.wordpress.com/2015/11/screen-shot-2015-10-28-at-2-00-59-pm.png?w=800" alt="Screen Shot 2015-10-28 at 2.00.59 PM" srcset="https://flickrcode.files.wordpress.com/2015/11/screen-shot-2015-10-28-at-2-00-59-pm.png 755w, https://flickrcode.files.wordpress.com/2015/11/screen-shot-2015-10-28-at-2-00-59-pm.png?w=150 150w" sizes="(max-width: 755px) 100vw, 755px"   /></p>
<p>That is it. Now if someone receives a text message with a Flickr link, she will jump right to the Flickr app when she taps on it.</p>
<h2><strong>Deep linking into the app</strong></h2>
<p>Great! We have Flickr photos showing up as search results and Flickr URLs opening directly in our app. Now we just have to get the user to the proper place within the app. There are different entry points into our app, and we need to make the implementation consistent and avoid code duplication.</p>
<p>iOS has been supporting deep linking for a while already and so has Flickr. To support deep linking, apps could register to handle custom URLs (meaning a custom scheme, such as myscheme://mydata/123). The website corresponding to the app could then publish links directly to the app. For every custom URL published on the Flickr website, our app translates it into a representation of the data to be shown. This representation looks like this:</p>
<pre class="brush: objc; title: ; notranslate" title="">
@interface FLKRoute : NSObject

@property (nonatomic) FLKRouteType type;
@property (nonatomic, copy) NSString *identifier;

@end
</pre>
<p>It describes the type of data to present, and a unique identifier for that type of data.</p>
<pre class="brush: objc; title: ; notranslate" title="">
- (void)navigateToRoute:(FLKRoute *)route
{
    switch (route.type) {
        case FLKRouteTypePhoto:
            // Navigate to photo screen
            break;
        case FLKRouteTypeAlbum:
           // Navigate to album screen
            break;
        case FLKRouteTypeGroup:
            // Navigate to group screen
            break;
        // ...
        default:
            break;
    }
}
</pre>
<p>Now, all we have to do is to make sure we are able to translate both NSURLs and NSUserActivity objects into FLKRoute instances. For NSURLs, this translation is straightforward. Our custom URLs follow the same pattern as the corresponding website URLs; their paths correspond exactly. So translating both website URLs and custom URLs is a matter of using NSURLComponents to extract the necessary information to create the FLKRoute object.</p>
<p>As for NSUserActivity objects passed into <code>application:continueUserActivity:restorationHandler:</code>, there are two cases. One arises when the NSUserActivity instance was used to index a public item in the app. Remember that when we created the NSUserActivity object we also assigned its <code>webpageURL</code>? This is really handy because it not only uniquely identifies the data we want to present, but also gives us a NSURL object, which we can handle the same way we handle deep links or Universal Links.</p>
<p>The other case is when the NSUserActivity originated from a CSSearchableItem; we have some more work to do in this case. We need to parse the identifier we created for the item and translate it into a FLKRoute. Remember that our item&#8217;s identifier is a combination of its type and the model ID. We can decompose it and then create our route object. Its simplified implementation looks like this:</p>
<pre class="brush: objc; title: ; notranslate" title="">
FLKRoute * FLKRouteFromSearchableItemIdentifier(NSString *searchableItemIdentifier)
{
    NSArray *routeComponents = [searchableItemIdentifier componentsSeparatedByString:@&quot;/&quot;];
    if ([routeComponents count] != 2) { // type + id
        return nil;
    }
    
    // Handle the route type
    NSString *searchableItemContentType = [routeComponents firstObject];
    FLKRouteType type = FLKRouteTypeFromSearchableItemContentType(searchableItemContentType);
    
    // Get the item identifier
    NSString *itemIdentifier = [routeComponents lastObject];
    
    // Build the route object
    FLKRoute *route = [FLKRoute new];
    route.type = type;
    route.parameter = itemIdentifier;
    
    return route;
}
</pre>
<p>Now we have all our bases covered and we&#8217;re sure that we’ll drop the user in the right place when she lands in our app. The final application delegate method looks like this:</p>
<pre class="brush: objc; title: ; notranslate" title="">
- (BOOL)application:(nonnull UIApplication *)application continueUserActivity:(nonnull NSUserActivity *)userActivity restorationHandler:(nonnull void (^)(NSArray * __nullable))restorationHandler
{
    FLKRoute *route;
    NSString *activityType = [userActivity activityType];
    NSURL *url;
    
    if ([activityType isEqualToString:CSSearchableItemActionType]) {
        // Searchable item from Core Spotlight
        NSString *itemIdentifier = [userActivity.userInfo objectForKey:CSSearchableItemActivityIdentifier];
        route = FLKRouteFromSearchableItemIdentifier(itemIdentifier);
        
    } else if ([activityType isEqualToString:@&quot;FLKSearchableUserActivityType&quot;] ||
               [activityType isEqualToString:NSUserActivityTypeBrowsingWeb]) {
        // Searchable item from NSUserActivity or Universal Link
        url = userActivity.webpageURL;
        route = [url flk_route];
        
    }
    
    if (route) {
        [self.router navigateToRoute:route];
        return YES;
    } else if (url) {
        [[UIApplication sharedApplication] openURL:url]; // Fail gracefully
        return YES;
    } else {
        return NO;
    }
}
</pre>
<h2><strong>3D Touch</strong></h2>
<p>With the release of iPhone 6S and iPhone 6S Plus, Apple introduced a new gesture that can be used with your iOS app: 3D Touch. One of the coolest features it has brought is the ability to preview content before pushing it onto the navigation stack. This is also known as &#8220;peek and pop.&#8221;</p>
<p>You can easily see how this feature is implemented in the native Mail app. But you won&#8217;t always have a simple UIView hierarchy like Mail’s UITableView, where a tap anywhere on a cell opens a UIViewController. Take Flickr&#8217;s notifications screen, for example:</p>
<p><img data-attachment-id="3273" data-permalink="https://code.flickr.net/2015/11/18/flickrs-experience-with-ios-9/4-0-04-core-five-notifications/" data-orig-file="https://flickrcode.files.wordpress.com/2015/11/4-0-04-core-five-notifications.png" data-orig-size="750,1334" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="4.0-04-core-five-notifications" data-image-description="" data-medium-file="https://flickrcode.files.wordpress.com/2015/11/4-0-04-core-five-notifications.png?w=450" data-large-file="https://flickrcode.files.wordpress.com/2015/11/4-0-04-core-five-notifications.png?w=576" class="aligncenter size-medium wp-image-3273" src="https://flickrcode.files.wordpress.com/2015/11/4-0-04-core-five-notifications.png?w=450&#038;h=800" alt="4.0-04-core-five-notifications" width="450" height="800" srcset="https://flickrcode.files.wordpress.com/2015/11/4-0-04-core-five-notifications.png?w=450&amp;h=800 450w, https://flickrcode.files.wordpress.com/2015/11/4-0-04-core-five-notifications.png?w=84&amp;h=150 84w, https://flickrcode.files.wordpress.com/2015/11/4-0-04-core-five-notifications.png 750w" sizes="(max-width: 450px) 100vw, 450px" /></p>
<p>If the user taps on a photo in one of these cells, it will open the photo view. But if the user taps on another user&#8217;s name, it will open that user’s profile view. Previews of these UIViewControllers should be shown accordingly. But the &#8220;peek and pop&#8221; mechanism requires you to register a delegate on your UIViewController with <code>registerForPreviewingWithDelegate:sourceView:</code>, which means that you’re working in a much higher layer. Your UIViewController’s view might not even know about its subviews’ structures.</p>
<p>To solve this problem, we used UIView&#8217;s method <code>hitTest:withEvent:</code>. As the documentation describes, it will give us the &#8220;farthest descendant of the receiver in the view hierarchy.&#8221; But not every hitTest will necessarily return the UIView that we want. So we defined a protocol, <code>FLKPeekAndPopTargetView</code>, that must be implemented by any UIView subclass that wants to support peeking and popping from it. That view is then responsible for returning the model used to populate the UIViewController that the user is trying to preview. If the view doesn&#8217;t implement this protocol, we query its superview. We keep checking for it until a UIView is found or there aren&#8217;t any more superviews available. This is how this logic looks:</p>
<pre class="brush: objc; title: ; notranslate" title="">
+ (id)modelAtLocation:(CGPoint)location inSourceView:(UIView*)sourceView
    
    // Walk up hit-test tree until we find a peek-pop target.
    UIView *testView = [sourceView hitTest:location withEvent:nil];
    id model = nil;
    while(testView &amp;&amp; !model) {
      
        // Check if the current testView conforms to the protocol.
        if([testView conformsToProtocol:@protocol(FLKPeekAndPopTargetView)]) {
            
            // Translate location to view coordinates.
            CGPoint locationInView = [testView convertPoint:location fromView:sourceView];
            
            // Get model from peek and pop target.
            model = [((id&lt;FLKPeekAndPopTargetView&gt;)testView) flk_peekAndPopModelAtLocation:locationInView];
            
        } else {
            //Move up view tree to next view
            testView = testView.superview;
        }
    }
    
    return model;
}
</pre>
<p>With this code in place, all we have to do is to implement <code>UIViewControllerPreviewingDelegate</code> methods in our delegate, perform the <code>hitTest</code> and take the model out of the <code>FLKPeekAndPopTargetView</code>&#8216;s implementor. Here&#8217;s is the final implementation:</p>
<pre class="brush: objc; title: ; notranslate" title="">
- (UIViewController *)previewingContext:(id&lt;UIViewControllerPreviewing&gt;)previewingContext
              viewControllerForLocation:(CGPoint)location {
    
    id model = [[self class] modelAtLocation:location inSourceView:previewingContext.sourceView];
    UIViewController *viewController = nil;
    if ([model isKindOfClass:[FLKPhoto class]]) {
        viewController = // ... UIViewController that displays a photo.
    } else if ([model isKindOfClass:[FLKAlbum class]]) {
        viewController = // ... UIViewController that displays an album.
    } else if ([model isKindOfClass:[FLKGroup class]]) {
        viewController = // ... UIViewController that displays a group.
    } // ...
    return viewController;
    
}

- (void)previewingContext:(id&lt;UIViewControllerPreviewing&gt;)previewingContext
     commitViewController:(UIViewController *)viewControllerToCommit {
    
    [self.navigationController pushViewController:viewControllerToCommit animated:YES];
    
}
</pre>
<p>Last but not least, we added support for Quick Actions. Now the user has the ability to quickly jump into a specific section of the app just by pressing down on the app icon. Defining these Quick Actions statically in the Info.plist file is an easy way to implement this feature, but we decided to go one step further and define these options dynamically. One of the options we provide is &#8220;Upload Photo,&#8221; which takes the user to the asset picker screen. But if the user has Auto Uploadr turned on, this option isn’t that relevant, so instead we provide a different app icon menu option in its place.</p>
<p>Here&#8217;s how you can create Quick Actions:</p>
<pre class="brush: objc; title: ; notranslate" title="">
NSMutableArray&lt;UIApplicationShortcutItem *&gt; *items = [NSMutableArray array];
    
[items addObject:[[UIApplicationShortcutItem alloc] initWithType:@&quot;FLKShortcutItemFeed&quot;
                                                  localizedTitle:NSLocalizedString(@&quot;Feed&quot;, nil)]];
    
[items addObject:[[UIApplicationShortcutItem alloc] initWithType:@&quot;FLKShortcutItemTakePhoto&quot;
                                                  localizedTitle:NSLocalizedString(@&quot;Upload Photo&quot;, nil)] ];

[items addObject:[[UIApplicationShortcutItem alloc] initWithType:@&quot;FLKShortcutItemNotifications&quot;
                                                  localizedTitle:NSLocalizedString(@&quot;Notifications&quot;, nil)]];
    
[items addObject:[[UIApplicationShortcutItem alloc] initWithType:@&quot;FLKShortcutItemSearch&quot;
                                                  localizedTitle:NSLocalizedString(@&quot;Search&quot;, nil)]];
    
[[UIApplication sharedApplication] setShortcutItems:items];
</pre>
<p>And this is how it looks like when the user presses down on the app icon:</p>
<p><img data-attachment-id="3270" data-permalink="https://code.flickr.net/2015/11/18/flickrs-experience-with-ios-9/img_0344/" data-orig-file="https://flickrcode.files.wordpress.com/2015/11/img_0344.png" data-orig-size="750,1334" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="IMG_0344" data-image-description="" data-medium-file="https://flickrcode.files.wordpress.com/2015/11/img_0344.png?w=450" data-large-file="https://flickrcode.files.wordpress.com/2015/11/img_0344.png?w=576" class="size-medium wp-image-3270 aligncenter" src="https://flickrcode.files.wordpress.com/2015/11/img_0344.png?w=450&#038;h=800" alt="IMG_0344" width="450" height="800" srcset="https://flickrcode.files.wordpress.com/2015/11/img_0344.png?w=450&amp;h=800 450w, https://flickrcode.files.wordpress.com/2015/11/img_0344.png?w=84&amp;h=150 84w, https://flickrcode.files.wordpress.com/2015/11/img_0344.png 750w" sizes="(max-width: 450px) 100vw, 450px" /></p>
<p>Finally, we have to handle where to take the user after she selects one of these options. This is yet another place where we can make use of our <code>FLKRoute</code> object. To handle the app opening from a Quick Action, we need to implement <code>application:performActionForShortcutItem:completionHandler:</code> in the app delegate.</p>
<pre class="brush: objc; title: ; notranslate" title="">
- (void)application:(UIApplication *)application performActionForShortcutItem:(UIApplicationShortcutItem *)shortcutItem completionHandler:(void (^)(BOOL))completionHandler {
    FLKRoute *route = [shortcutItem flk_route];
     [self.router navigateToRoute:route];
    completionHandler(YES);
}
</pre>
<h2><strong>Conclusion</strong></h2>
<p>There is a lot more to consider when shipping these features with an app. For example, with Flickr, there are various platforms the user could be using. It is important to make sure that the Spotlight index is up to date to reflect changes made anywhere. If the user has created a new album and/or left a group from his desktop browser, we need to make sure that those changes are reflected in the app, so the newly-created album can be found through Spotlight, but the newly-departed group cannot.</p>
<p>All of this work should be totally opaque to the user, without hogging the device&#8217;s resources and deteriorating the user experience overall. That requires some considerations around threading and network priorities. Network requests for UI-relevant data should not be blocked because we have other network requests happening at the same time. With some careful prioritizing, using <code>NSOperationQueue</code> and <code>NSURLSession</code>, we managed to accomplish this with no major problems.</p>
<p>Finally, we had to consider privacy, one of the pillars of Flickr. We had to be extremely careful not to violate any of the user&#8217;s settings. We’re careful to never publicly index private content, such as photos and albums. Also, photos marked “restricted” are not publicly indexed since they might expose content that some users might consider offensive.</p>
<p>In this blog post we went into the basics of integrating iOS 9 Search, Universal Links, and 3D Touch in Flickr for iOS. In order to focus on those features, we simplified some of our examples to demonstrate how you could get started with them in your own app, and to show what challenges we faced.</p>
<div class="hiring-banner">
<p class="group-photo"><a title="Flickr September 2014 by Bhautik Joshi, on Flickr" href="https://www.flickr.com/photos/captin_nod/14965686478/"><img src="https://farm4.staticflickr.com/3893/14965686478_9278dbe39c_m.jpg" alt="Flickr September 2014" width="120" height="80" /></a></p>
<p>Like this post? Have a love of online photography? Want to work with us? Flickr is hiring <strong>mobile, back-end and front-end engineers</strong>, in our San Francisco office. <strong>Find out more at <a href="https://www.flickr.com/jobs/">flickr.com/jobs</a></strong>.</p>
</div>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="https://code.flickr.net/category/uncategorized/" rel="category tag">Uncategorized</a>			</span>
															
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-3238 -->

				
						<nav id="nav-below">
			<h3 class="assistive-text">Post navigation</h3>
			<div class="nav-previous"><a href="https://code.flickr.net/page/2/" ><span class="meta-nav">&larr;</span> Older posts</a></div>
			<div class="nav-next"></div>
		</nav><!-- #nav-above -->
	
			
			</div><!-- #content -->
		</div><!-- #primary -->

		<div id="secondary" class="widget-area" role="complementary">
					<aside id="search-2" class="widget widget_search">	<form method="get" id="searchform" action="https://code.flickr.net/">
		<label for="s" class="assistive-text">Search</label>
		<input type="text" class="field" name="s" id="s" placeholder="Search" />
		<input type="submit" class="submit" name="submit" id="searchsubmit" value="Search" />
	</form>
</aside>		<aside id="recent-posts-2" class="widget widget_recent_entries">		<h3 class="widget-title">Recent Posts</h3>		<ul>
											<li>
					<a href="https://code.flickr.net/2018/04/20/together/">Together</a>
									</li>
											<li>
					<a href="https://code.flickr.net/2017/03/07/introducing-similarity-search-at-flickr/">Introducing Similarity Search at&nbsp;Flickr</a>
									</li>
											<li>
					<a href="https://code.flickr.net/2017/01/05/a-year-without-a-byte/">A Year Without a&nbsp;Byte</a>
									</li>
											<li>
					<a href="https://code.flickr.net/2016/09/30/personalized-group-recommendations-on-flickr/">Personalized Group Recommendations on&nbsp;Flickr</a>
									</li>
											<li>
					<a href="https://code.flickr.net/2016/05/11/we-want-you-and-your-teammates/">We Want You&#8230; and Your&nbsp;Teammates</a>
									</li>
					</ul>
		</aside><aside id="archives-2" class="widget widget_archive"><h3 class="widget-title">Archives</h3>		<ul>
				<li><a href='https://code.flickr.net/2018/04/'>April 2018</a></li>
	<li><a href='https://code.flickr.net/2017/03/'>March 2017</a></li>
	<li><a href='https://code.flickr.net/2017/01/'>January 2017</a></li>
	<li><a href='https://code.flickr.net/2016/09/'>September 2016</a></li>
	<li><a href='https://code.flickr.net/2016/05/'>May 2016</a></li>
	<li><a href='https://code.flickr.net/2016/04/'>April 2016</a></li>
	<li><a href='https://code.flickr.net/2016/03/'>March 2016</a></li>
	<li><a href='https://code.flickr.net/2015/12/'>December 2015</a></li>
	<li><a href='https://code.flickr.net/2015/11/'>November 2015</a></li>
	<li><a href='https://code.flickr.net/2015/09/'>September 2015</a></li>
	<li><a href='https://code.flickr.net/2015/07/'>July 2015</a></li>
	<li><a href='https://code.flickr.net/2015/06/'>June 2015</a></li>
	<li><a href='https://code.flickr.net/2015/03/'>March 2015</a></li>
	<li><a href='https://code.flickr.net/2014/10/'>October 2014</a></li>
	<li><a href='https://code.flickr.net/2014/08/'>August 2014</a></li>
	<li><a href='https://code.flickr.net/2014/07/'>July 2014</a></li>
	<li><a href='https://code.flickr.net/2014/05/'>May 2014</a></li>
	<li><a href='https://code.flickr.net/2014/04/'>April 2014</a></li>
	<li><a href='https://code.flickr.net/2014/02/'>February 2014</a></li>
	<li><a href='https://code.flickr.net/2013/09/'>September 2013</a></li>
	<li><a href='https://code.flickr.net/2013/06/'>June 2013</a></li>
	<li><a href='https://code.flickr.net/2013/03/'>March 2013</a></li>
	<li><a href='https://code.flickr.net/2012/12/'>December 2012</a></li>
	<li><a href='https://code.flickr.net/2012/10/'>October 2012</a></li>
	<li><a href='https://code.flickr.net/2012/07/'>July 2012</a></li>
	<li><a href='https://code.flickr.net/2012/06/'>June 2012</a></li>
	<li><a href='https://code.flickr.net/2012/05/'>May 2012</a></li>
	<li><a href='https://code.flickr.net/2012/04/'>April 2012</a></li>
	<li><a href='https://code.flickr.net/2012/02/'>February 2012</a></li>
	<li><a href='https://code.flickr.net/2012/01/'>January 2012</a></li>
	<li><a href='https://code.flickr.net/2011/12/'>December 2011</a></li>
	<li><a href='https://code.flickr.net/2011/10/'>October 2011</a></li>
	<li><a href='https://code.flickr.net/2011/09/'>September 2011</a></li>
	<li><a href='https://code.flickr.net/2011/08/'>August 2011</a></li>
	<li><a href='https://code.flickr.net/2011/07/'>July 2011</a></li>
	<li><a href='https://code.flickr.net/2011/06/'>June 2011</a></li>
	<li><a href='https://code.flickr.net/2011/03/'>March 2011</a></li>
	<li><a href='https://code.flickr.net/2011/02/'>February 2011</a></li>
	<li><a href='https://code.flickr.net/2011/01/'>January 2011</a></li>
	<li><a href='https://code.flickr.net/2010/11/'>November 2010</a></li>
	<li><a href='https://code.flickr.net/2010/10/'>October 2010</a></li>
	<li><a href='https://code.flickr.net/2010/09/'>September 2010</a></li>
	<li><a href='https://code.flickr.net/2010/08/'>August 2010</a></li>
	<li><a href='https://code.flickr.net/2010/07/'>July 2010</a></li>
	<li><a href='https://code.flickr.net/2010/05/'>May 2010</a></li>
	<li><a href='https://code.flickr.net/2010/04/'>April 2010</a></li>
	<li><a href='https://code.flickr.net/2010/03/'>March 2010</a></li>
	<li><a href='https://code.flickr.net/2010/02/'>February 2010</a></li>
	<li><a href='https://code.flickr.net/2010/01/'>January 2010</a></li>
	<li><a href='https://code.flickr.net/2009/12/'>December 2009</a></li>
	<li><a href='https://code.flickr.net/2009/11/'>November 2009</a></li>
	<li><a href='https://code.flickr.net/2009/10/'>October 2009</a></li>
	<li><a href='https://code.flickr.net/2009/09/'>September 2009</a></li>
	<li><a href='https://code.flickr.net/2009/07/'>July 2009</a></li>
	<li><a href='https://code.flickr.net/2009/06/'>June 2009</a></li>
	<li><a href='https://code.flickr.net/2009/05/'>May 2009</a></li>
	<li><a href='https://code.flickr.net/2009/04/'>April 2009</a></li>
	<li><a href='https://code.flickr.net/2009/03/'>March 2009</a></li>
	<li><a href='https://code.flickr.net/2009/02/'>February 2009</a></li>
	<li><a href='https://code.flickr.net/2009/01/'>January 2009</a></li>
	<li><a href='https://code.flickr.net/2008/12/'>December 2008</a></li>
	<li><a href='https://code.flickr.net/2008/11/'>November 2008</a></li>
	<li><a href='https://code.flickr.net/2008/10/'>October 2008</a></li>
	<li><a href='https://code.flickr.net/2008/09/'>September 2008</a></li>
	<li><a href='https://code.flickr.net/2008/08/'>August 2008</a></li>
	<li><a href='https://code.flickr.net/2008/07/'>July 2008</a></li>
	<li><a href='https://code.flickr.net/2008/06/'>June 2008</a></li>
	<li><a href='https://code.flickr.net/2008/05/'>May 2008</a></li>
	<li><a href='https://code.flickr.net/2008/04/'>April 2008</a></li>
		</ul>
			</aside><aside id="categories-2" class="widget widget_categories"><h3 class="widget-title">Categories</h3>		<ul>
				<li class="cat-item cat-item-11749740"><a href="https://code.flickr.net/category/api-2/">API</a>
</li>
	<li class="cat-item cat-item-564792"><a href="https://code.flickr.net/category/change-log/">changelog</a>
</li>
	<li class="cat-item cat-item-5784"><a href="https://code.flickr.net/category/event/">event</a>
</li>
	<li class="cat-item cat-item-29160"><a href="https://code.flickr.net/category/geo/" title="All things geo related">geo</a>
</li>
	<li class="cat-item cat-item-139037766"><a href="https://code.flickr.net/category/hadoop/">hadoop</a>
</li>
	<li class="cat-item cat-item-32"><a href="https://code.flickr.net/category/infrastructure/">infrastructure</a>
</li>
	<li class="cat-item cat-item-139037765"><a href="https://code.flickr.net/category/kittens/">kittens</a>
</li>
	<li class="cat-item cat-item-20156"><a href="https://code.flickr.net/category/labs/">labs</a>
</li>
	<li class="cat-item cat-item-171"><a href="https://code.flickr.net/category/meta/">meta</a>
</li>
	<li class="cat-item cat-item-7092"><a href="https://code.flickr.net/category/metrics/">metrics</a>
</li>
	<li class="cat-item cat-item-139037764"><a href="https://code.flickr.net/category/open-source/">open source</a>
</li>
	<li class="cat-item cat-item-1930"><a href="https://code.flickr.net/category/performance/">performance</a>
</li>
	<li class="cat-item cat-item-304"><a href="https://code.flickr.net/category/photos/">photos</a>
</li>
	<li class="cat-item cat-item-2373"><a href="https://code.flickr.net/category/search/">search</a>
</li>
	<li class="cat-item cat-item-1"><a href="https://code.flickr.net/category/uncategorized/">Uncategorized</a>
</li>
	<li class="cat-item cat-item-249276"><a href="https://code.flickr.net/category/uploadr/">uploadr</a>
</li>
	<li class="cat-item cat-item-412"><a href="https://code.flickr.net/category/video/">video</a>
</li>
	<li class="cat-item cat-item-830560"><a href="https://code.flickr.net/category/xulrunner/">xulrunner</a>
</li>
		</ul>
			</aside><aside id="meta-2" class="widget widget_meta"><h3 class="widget-title">Meta</h3>			<ul>
			<li><a href="https://wordpress.com/start?ref=wplogin">Register</a></li>			<li><a href="https://flickrcode.wordpress.com/wp-login.php">Log in</a></li>
			<li><a href="https://code.flickr.net/feed/">Entries <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li><a href="https://code.flickr.net/comments/feed/">Comments <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li>Powered by <a href="https://wpvip.com/?utm_source=vip_powered_wpcom&#038;utm_medium=web&#038;utm_campaign=VIP%20Footer%20Credit&#038;utm_term=code.flickr.net" rel="generator nofollow" class="powered-by-wpcom">WordPress.com VIP</a></li>			</ul>
			</aside>		</div><!-- #secondary .widget-area -->
	</div><!-- #main -->

	<footer id="colophon" role="contentinfo">

			

			<div id="site-generator">
				Theme: Twenty Eleven <span class="sep"> | </span>				Powered by <a href="https://wpvip.com/?utm_source=vip_powered_wpcom&#038;utm_medium=web&#038;utm_campaign=VIP%20Footer%20Credit&#038;utm_term=code.flickr.net" rel="generator nofollow" class="powered-by-wpcom">WordPress.com VIP</a>			</div>
	</footer><!-- #colophon -->
</div><!-- #page -->

<!-- wpcom_wp_footer -->
<script type='text/javascript' src='//0.gravatar.com/js/gprofiles.js?ver=201932y'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var WPGroHo = {"my_hash":""};
/* ]]> */
</script>
<script type='text/javascript' src='https://s1.wp.com/wp-content/mu-plugins/gravatar-hovercards/wpgroho.js?m=1380573781h'></script>

	<script>
		//initialize and attach hovercards to all gravatars
		jQuery( document ).ready( function( $ ) {

			if (typeof Gravatar === "undefined"){
				return;
			}

			if ( typeof Gravatar.init !== "function" ) {
				return;
			}			

			Gravatar.profile_cb = function( hash, id ) {
				WPGroHo.syncProfileData( hash, id );
			};
			Gravatar.my_hash = WPGroHo.my_hash;
			Gravatar.init( 'body', '#wp-admin-bar-my-account' );
		});
	</script>

		<div style="display:none">
	</div>

	<div id="carousel-reblog-box">
		<form action="#" name="carousel-reblog">
			<textarea id="carousel-reblog-content" name="carousel-reblog-content" placeholder="Add your thoughts here... (optional)"></textarea>
			<label for="carousel-reblog-to-blog-id" id="carousel-reblog-lblogid">Post to</label>
			<select name="carousel-reblog-to-blog-id" id="carousel-reblog-to-blog-id">
						</select>

			<div class="submit">
				<span class="canceltext"><a href="#" class="cancel">Cancel</a></span>
				<input type="submit" name="carousel-reblog-submit" class="button" id="carousel-reblog-submit" value="Reblog Post" />
				<input type="hidden" id="carousel-reblog-blog-id" value="39034126" />
				<input type="hidden" id="carousel-reblog-blog-url" value="https://code.flickr.net" />
				<input type="hidden" id="carousel-reblog-blog-title" value="code.flickr.com" />
				<input type="hidden" id="carousel-reblog-post-url" value="" />
				<input type="hidden" id="carousel-reblog-post-title" value="" />
			</div>

			<input type="hidden" id="_wpnonce" name="_wpnonce" value="cc67b45e32" /><input type="hidden" name="_wp_http_referer" value="/" />		</form>

		<div class="arrow"></div>
	</div>
<script type='text/javascript' src='https://s2.wp.com/_static/??-eJzTLy/QTc7PK0nNK9EvyClNz8wr1i+uzCtJrMjITM/IAeKS1CJMEWP94uSizIISoOIM5/yiVL2sYh19oowqycgsStEtSCwqqdRNKiotzkgFmeEEYvknZTkTbxBeN4HNC8hJzMwDGmifa2toamJkZmZibGaeBQAB0VzE'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "https://s1.wp.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.9b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.head.appendChild( corecss );
		var themecssurl = "https://s2.wp.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?m=1363304414h&amp;ver=3.0.9b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		document.head.appendChild( themecss );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.defaults['toolbar'] = false;
	SyntaxHighlighter.all();

	// Infinite scroll support
	if ( typeof( jQuery ) !== 'undefined' ) {
		jQuery( function( $ ) {
			$( document.body ).on( 'post-load', function() {
				SyntaxHighlighter.highlight();
			} );
		} );
	}
</script>
<link rel='stylesheet' id='all-css-0-2' href='https://s0.wp.com/wp-content/mu-plugins/carousel/jetpack-carousel.css?m=1563361695h&cssminify=yes' type='text/css' media='all' />
<script type='text/javascript'>
/* <![CDATA[ */
var wpcomVipAnalytics = {"is_404":"0","is_home":"1","is_single":"0","is_front_page":"1","is_archive":"0","percentToTrack":"1"};
/* ]]> */
</script>
<script type='text/javascript'>
/* <![CDATA[ */
var jetpackCarouselStrings = {"widths":[370,700,1000,1200,1400,2000],"is_logged_in":"","lang":"en","ajaxurl":"https:\/\/code.flickr.net\/wp-admin\/admin-ajax.php","nonce":"c2c1a5aa35","display_exif":"1","display_geo":"1","single_image_gallery":"1","single_image_gallery_media_file":"","background_color":"black","comment":"Comment","post_comment":"Post Comment","write_comment":"Write a Comment...","loading_comments":"Loading Comments...","download_original":"View full size <span class=\"photo-size\">{0}<span class=\"photo-size-times\">\u00d7<\/span>{1}<\/span>","no_comment_text":"Please be sure to submit some text with your comment.","no_comment_email":"Please provide an email address to comment.","no_comment_author":"Please provide your name to comment.","comment_post_error":"Sorry, but there was an error posting your comment. Please try again later.","comment_approved":"Your comment was approved.","comment_unapproved":"Your comment is in moderation.","camera":"Camera","aperture":"Aperture","shutter_speed":"Shutter Speed","focal_length":"Focal Length","copyright":"Copyright","comment_registration":"0","require_name_email":"1","login_url":"https:\/\/flickrcode.wordpress.com\/wp-login.php?redirect_to=https%3A%2F%2Fcode.flickr.net%2F2017%2F03%2F07%2Fintroducing-similarity-search-at-flickr%2F","blog_id":"39034126","meta_data":["camera","aperture","shutter_speed","focal_length","copyright"],"local_comments_commenting_as":"<fieldset><label for=\"email\">Email (Required)<\/label> <input type=\"text\" name=\"email\" class=\"jp-carousel-comment-form-field jp-carousel-comment-form-text-field\" id=\"jp-carousel-comment-form-email-field\" \/><\/fieldset><fieldset><label for=\"author\">Name (Required)<\/label> <input type=\"text\" name=\"author\" class=\"jp-carousel-comment-form-field jp-carousel-comment-form-text-field\" id=\"jp-carousel-comment-form-author-field\" \/><\/fieldset><fieldset><label for=\"url\">Website<\/label> <input type=\"text\" name=\"url\" class=\"jp-carousel-comment-form-field jp-carousel-comment-form-text-field\" id=\"jp-carousel-comment-form-url-field\" \/><\/fieldset>","reblog":"Reblog","reblogged":"Reblogged","reblog_add_thoughts":"Add your thoughts here... (optional)","reblogging":"Reblogging...","post_reblog":"Post Reblog","stats_query_args":"blog=39034126&v=wpcom&tz=-7&user_id=0&subd=flickrcode","is_public":"1","reblog_enabled":""};
/* ]]> */
</script>
<script type='text/javascript' src='https://s1.wp.com/_static/??-eJyVj9EOgjAMRX/IsWhAeTF+yxwNdIxtthvK3zsSJDwQEp/a3N7e08p3ENq7CC5Kw7KBETWET2H4JDejIYlgU4uOpcUeWL4SJOiUayzQgfkiRgxzcC5COWWniJoPFlQzoBNPRXJQHIFyJ/wIRNhk6qr9mRBJ6X7FotM2zXH5Lg7o9nSTH6RpKcXWtYPUinxisNJADJkkfsLBDneeovYLrkWO2fwY7ufqWlbVra5L8wUchJnC'></script>
<script type="text/javascript">
// <![CDATA[
(function() {
try{
  if ( window.external &&'msIsSiteMode' in window.external) {
    if (window.external.msIsSiteMode()) {
      var jl = document.createElement('script');
      jl.type='text/javascript';
      jl.async=true;
      jl.src='/wp-content/plugins/ie-sitemode/custom-jumplist.php';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(jl, s);
    }
  }
}catch(e){}
})();
// ]]>
</script><script src="//stats.wp.com/w.js?60" type="text/javascript" async defer></script>
<script type="text/javascript">
_tkq = window._tkq || [];
_stq = window._stq || [];
_tkq.push(['storeContext', {'blog_id':'39034126','blog_tz':'-7','user_lang':'en','blog_lang':'en','user_id':'0'}]);
_stq.push(['view', {'blog':'39034126','v':'wpcom','tz':'-7','user_id':'0','subd':'flickrcode'}]);
function st_vt() {var x=document.createElement("img");x.src="https://pixel.wp.com/g.gif?blog=39034126&v=wpcomvt&tz=-7&user_id=0&subd=flickrcode&rand="+Math.random();}
_stq.push(['extra', {'crypt':'UE40eW5QN0p8M2Y/RE1BNmNJfGhxNCVxUDExYmtib2E/SzdEJm0lUEtbdFU0fFk4cHZvcUFrZT90Tn4yQm1+R3NyNTd1LERUSXUlJUR4VXctdEJxVkl1M2x0YkMlZVZTRmItR0UzMWxFbng0PS1sLzlGVEhTJTdKcWtBTVloUktfVjREOWlfPVMlTzNQVFk4QjV6YX5aNzBDQm1xT3M9XWRPclttRDBhVCZ3d1o1USwrSThZT01Taks2V3JlZ016TFY1Z3VfLnNtTXlCNlJVZFM0RTZYb3ctcFFOUHdQfCVJYU1UTFZtT3lYTyZzeUdYVE9O'}]);
_stq.push([ 'clickTrackerInit', '39034126', '0' ]);
	</script>
<noscript><img src="https://pixel.wp.com/b.gif?v=noscript" style="height:0px;width:0px;overflow:hidden" alt="" /></noscript>
<script>
if ( 'object' === typeof wpcom_mobile_user_agent_info ) {

	wpcom_mobile_user_agent_info.init();
	var mobileStatsQueryString = "";
	
	if( false !== wpcom_mobile_user_agent_info.matchedPlatformName )
		mobileStatsQueryString += "&x_" + 'mobile_platforms' + '=' + wpcom_mobile_user_agent_info.matchedPlatformName;
	
	if( false !== wpcom_mobile_user_agent_info.matchedUserAgentName )
		mobileStatsQueryString += "&x_" + 'mobile_devices' + '=' + wpcom_mobile_user_agent_info.matchedUserAgentName;
	
	if( wpcom_mobile_user_agent_info.isIPad() )
		mobileStatsQueryString += "&x_" + 'ipad_views' + '=' + 'views';

	if( "" != mobileStatsQueryString ) {
		new Image().src = document.location.protocol + '//pixel.wp.com/g.gif?v=wpcom-no-pv' + mobileStatsQueryString + '&baba=' + Math.random();
	}
	
}
</script>
<script async src="https://embedr.flickr.com/assets/client-code.js" charset="utf-8"></script>

</body>
</html>
